<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MobilityPricing ¬∑ Sion</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=Instrument+Serif:ital@0;1&family=JetBrains+Mono:wght@400;500&display=swap');
:root {
  --bg:#13202e; --s1:#1a2a3a; --s2:#203040; --s3:#263648;
  --bd:#304860; --bd2:#3e5870;
  --tx:#e8f2ff; --tx2:#8aaac8; --tx3:#4a6080;
  --ac:#2563eb; --ac-d:rgba(37,99,235,.12);
  --tl:#0d9488; --tl-d:rgba(13,148,136,.10);
  --gn:#16a34a; --gn-d:rgba(22,163,74,.10);
  --or:#d97706; --or-d:rgba(217,119,6,.10);
  --rd:#dc2626; --rd-d:rgba(220,38,38,.10);
  --gd:#ca8a04; --r:8px; --rs:5px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Syne',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;font-size:13px;line-height:1.5;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-thumb{background:var(--bd2);border-radius:2px}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{height:50px;background:var(--s1);border-bottom:1px solid var(--bd);display:flex;align-items:center;padding:0 14px;gap:10px;position:sticky;top:0;z-index:200}
.brand{display:flex;align-items:center;gap:9px}
.brand-mark{width:28px;height:28px;background:linear-gradient(135deg,var(--ac),#1d4ed8);border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:15px;box-shadow:0 0 12px rgba(37,99,235,.3)}
.brand-name{font-weight:800;font-size:14px;letter-spacing:-.4px}
.brand-city{font-size:10px;color:var(--tx3);margin-top:-2px}
.beta{font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;padding:2px 6px;border-radius:3px;background:rgba(202,138,4,.15);color:var(--gd);border:1px solid rgba(202,138,4,.3);letter-spacing:.05em;text-transform:uppercase}
.lab{font-size:10px;color:var(--tx3);display:flex;align-items:center;gap:4px;padding:3px 8px;border-left:1px solid var(--bd)}
.hdr-sep{width:1px;height:20px;background:var(--bd);flex-shrink:0}
.sp{flex:1}
.dq-bar{display:flex;gap:4px;align-items:center}
.dq{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:3px;font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace;border:1px solid;text-transform:uppercase;letter-spacing:.04em;cursor:help}
.dq.real{color:#22c55e;border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.06)}
.dq.sim{color:var(--gd);border-color:rgba(202,138,4,.3);background:rgba(202,138,4,.06)}
.dq.hyp{color:#c084fc;border-color:rgba(192,132,252,.3);background:rgba(192,132,252,.06)}
.dq.live{color:#60a5fa;border-color:rgba(96,165,250,.3);background:rgba(96,165,250,.06);cursor:pointer}
.mode-tog{display:flex;background:var(--s3);border:1px solid var(--bd);border-radius:20px;padding:2px}
.mbtn{padding:3px 13px;border-radius:16px;font-size:11px;font-weight:600;font-family:'Syne',sans-serif;cursor:pointer;border:none;background:transparent;color:var(--tx2);transition:all .15s}
.mbtn.on{background:var(--ac);color:#fff}
.tt-btn{display:flex;align-items:center;gap:5px;font-size:10px;font-family:'JetBrains Mono',monospace;color:var(--tx3);padding:3px 9px;border:1px solid var(--bd);border-radius:4px;cursor:pointer;transition:all .15s}
.tt-btn:hover{border-color:var(--bd2);color:var(--tx2)}
.tt-dot{width:6px;height:6px;border-radius:50%;background:var(--tx3)}
.tt-dot.ok{background:#22c55e;box-shadow:0 0 5px rgba(34,197,94,.4);animation:pulse 2s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{display:grid;grid-template-columns:362px 1fr;height:calc(100vh - 50px)}
.app.mode-simple .xo{display:none!important}

/* ‚îÄ‚îÄ LEFT ‚îÄ‚îÄ */
.left{background:var(--s1);border-right:1px solid var(--bd);overflow-y:auto;display:flex;flex-direction:column}
.sctabs{display:flex;padding:0 14px;border-bottom:1px solid var(--bd)}
.stab{flex:1;padding:8px 4px;font-size:10px;font-weight:700;font-family:'Syne',sans-serif;cursor:pointer;border:none;background:transparent;color:var(--tx3);border-bottom:2px solid transparent;transition:all .15s;letter-spacing:.06em;text-transform:uppercase}
.stab.on{color:var(--ac);border-bottom-color:var(--ac)}
.ps{padding:13px 14px;border-bottom:1px solid var(--bd)}
.pst{font-size:9px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--tx3);margin-bottom:11px;display:flex;align-items:center;gap:5px}
.pst-d{width:5px;height:5px;border-radius:50%}

/* Price Impact Panel */
.pip{background:var(--s2);border:1px solid var(--bd);border-radius:var(--r);padding:10px 13px;margin-bottom:12px}
.pip-h{font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--tx3);margin-bottom:8px;display:flex;align-items:center;gap:5px}
.pip-h::before{content:'‚ü°';color:var(--ac);font-size:11px}
.pip-r{display:flex;justify-content:space-between;align-items:center;font-size:11px;padding:2px 0}
.pip-k{color:var(--tx2)}
.pip-v{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:500}
.pip-v.g{color:var(--tl)}.pip-v.r{color:#f87171}.pip-v.o{color:var(--gd)}
.pip-n{font-size:9px;color:var(--tx3);margin-top:6px;padding-top:6px;border-top:1px solid var(--bd);font-style:italic;line-height:1.5}

/* Parking real cards */
.pcards{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.pcard{background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:8px 10px;display:flex;align-items:center;gap:8px;cursor:pointer;transition:border-color .12s}
.pcard:hover{border-color:var(--bd2)}
.pcard.sel{border-color:var(--ac);background:var(--ac-d)}
.pc-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.pc-inf{flex:1}
.pc-n{font-size:11px;font-weight:600;color:var(--tx)}
.pc-d{font-size:9px;color:var(--tx3);font-family:'JetBrains Mono',monospace;margin-top:1px}
.pc-pr{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:600;color:var(--ac);text-align:right}
.pc-src{font-size:8px;color:var(--tx3);text-align:right;margin-top:1px}

/* Sliders */
.sg{margin-bottom:12px}.sg:last-child{margin-bottom:0}
.sg-h{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:3px}
.sg-l{font-size:12px;font-weight:500;color:var(--tx)}
.sg-v{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;color:var(--ac);background:var(--ac-d);border:1px solid rgba(37,99,235,.25);padding:1px 7px;border-radius:3px;min-width:60px;text-align:center}
.sg-s{font-size:9px;color:var(--tx3);font-family:'JetBrains Mono',monospace;margin-bottom:4px;display:flex;align-items:center;gap:3px}
.sd{width:5px;height:5px;border-radius:50%;flex-shrink:0}
input[type=range]{-webkit-appearance:none;width:100%;height:3px;border-radius:2px;background:var(--bd);outline:none;cursor:pointer}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;border-radius:50%;background:var(--tx);border:2px solid var(--ac);transition:transform .1s}
input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.25)}
input[type=range]::-webkit-slider-runnable-track{background:linear-gradient(to right,var(--ac) var(--pct,0%),var(--bd) var(--pct,0%));height:3px;border-radius:2px}

/* Toggles */
.tr{display:flex;align-items:center;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bd)}
.tr:last-child{border-bottom:none}
.tr-i{flex:1}
.tr-n{font-size:11px;font-weight:500;color:var(--tx);display:flex;align-items:center;gap:5px}
.tr-d{font-size:9px;color:var(--tx3);margin-top:1px;line-height:1.4}
.pill{font-size:8px;font-family:'JetBrains Mono',monospace;font-weight:700;padding:1px 5px;border-radius:3px;border:1px solid;text-transform:uppercase}
.pill.new{color:var(--tl);border-color:rgba(13,148,136,.4)}
.pill.eq{color:#c084fc;border-color:rgba(192,132,252,.4)}
.pill.live{color:#60a5fa;border-color:rgba(96,165,250,.4)}
.tog{position:relative;width:30px;height:17px;flex-shrink:0;margin-left:10px;cursor:pointer}
.tog input{display:none}
.tok{position:absolute;inset:0;background:var(--bd2);border-radius:9px;transition:background .2s}
.tog input:checked+.tok{background:var(--ac)}
.tth{position:absolute;top:2px;left:2px;width:13px;height:13px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.4)}
.tog input:checked~.tth{transform:translateX(13px)}

/* Equity */
.eq-p{background:rgba(220,38,38,.07);border:1px solid rgba(220,38,38,.2);border-radius:var(--rs);padding:9px 11px;display:none}
.eq-p.vis{display:block}
.eq-t{font-size:11px;font-weight:600;color:#f87171;margin-bottom:4px}
.eq-b{font-size:10px;color:#fca5a5;line-height:1.55}

/* Hypotheses */
.hyp-tog{font-size:10px;color:var(--tx3);cursor:pointer;display:flex;align-items:center;gap:4px;font-family:'JetBrains Mono',monospace;padding:5px 0;user-select:none}
.hyp-tog:hover{color:var(--tx2)}
.hyp-body{display:none;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:8px 10px;margin-top:4px}
.hyp-body.open{display:block}
.hi{font-size:9px;color:var(--tx2);padding:2px 0 2px 11px;position:relative;font-family:'JetBrains Mono',monospace;line-height:1.6}
.hi::before{content:'¬∑';position:absolute;left:3px;color:var(--tx3)}
.hi.real{color:#86efac}
.hr{margin-top:6px;padding-top:6px;border-top:1px solid var(--bd);font-size:8px;color:var(--tx3);font-family:'JetBrains Mono',monospace;line-height:1.7}

/* Persona strip */
.pstrip{display:flex;gap:5px;overflow-x:auto;padding:1px;scrollbar-width:none}
.pstrip::-webkit-scrollbar{display:none}
.pchip{flex-shrink:0;padding:7px 8px;border-radius:var(--rs);border:1px solid var(--bd);background:var(--s2);cursor:pointer;transition:all .12s;text-align:center;min-width:68px}
.pchip:hover{border-color:var(--ac)}
.pchip.risk{border-color:rgba(220,38,38,.4);background:rgba(220,38,38,.05)}
.pe{font-size:17px;display:block}
.pn{font-size:8px;font-weight:500;color:var(--tx3);margin-top:2px;line-height:1.2}
.pd{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:500;margin-top:2px}
.pd.pos{color:#f87171}.pd.neg{color:var(--tl)}.pd.neu{color:var(--tx3)}

/* ‚îÄ‚îÄ RIGHT ‚îÄ‚îÄ */
.right{display:flex;flex-direction:column;background:var(--bg);overflow:hidden}
.vtabs{display:flex;background:var(--s1);border-bottom:1px solid var(--bd);padding:0 14px}
.vt{padding:9px 14px;font-size:10px;font-weight:700;font-family:'Syne',sans-serif;letter-spacing:.06em;text-transform:uppercase;color:var(--tx3);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;transition:all .15s}
.vt.on{color:var(--tx);border-bottom-color:var(--ac)}
.view{display:none;flex:1;flex-direction:column;overflow:hidden}
.view.on{display:flex}

/* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
.mapw{position:relative;flex:1;overflow:hidden;background:#0a1524}
.msvg{width:100%;height:100%}
.zone-g{cursor:pointer}
.zone-g:hover .zf{filter:brightness(1.2)}
.pmark{cursor:pointer;transition:all .2s}
.pmark:hover{filter:brightness(1.4) drop-shadow(0 0 6px currentColor)}

/* Tooltip */
.mtt{position:absolute;background:var(--s1);border:1px solid var(--bd2);padding:9px 12px;border-radius:var(--r);font-size:11px;pointer-events:none;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,.5);opacity:0;transition:opacity .1s;z-index:50;transform:translate(-50%,calc(-100% - 10px))}
.mtt.vis{opacity:1}
.mtt-t{font-weight:700;color:var(--tx);margin-bottom:5px;font-size:12px}
.mtt-r{display:flex;justify-content:space-between;gap:16px;color:var(--tx2);margin-bottom:2px}
.mtt-v{font-family:'JetBrains Mono',monospace;color:var(--tx)}
.mtt-s{margin-top:5px;padding-top:5px;border-top:1px solid var(--bd);font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--tx3)}

/* Mode split overlay */
.mso{position:absolute;top:12px;right:12px;background:rgba(6,12,19,.93);border:1px solid var(--bd);border-radius:var(--r);padding:12px;width:200px;backdrop-filter:blur(10px)}
.mso-t{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);margin-bottom:3px}
.mso-z{font-size:12px;font-weight:600;color:var(--tx);margin-bottom:9px}
.mso-row{display:flex;align-items:center;gap:5px;margin-bottom:5px}
.mso-l{font-size:10px;color:var(--tx2);width:62px;flex-shrink:0}
.mso-tr{flex:1;height:5px;background:var(--s3);border-radius:3px;overflow:hidden}
.mso-f{height:100%;border-radius:3px;transition:width .5s cubic-bezier(.4,0,.2,1)}
.mso-p{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--tx3);width:24px;text-align:right}

/* Filter bar */
.fbar{display:flex;align-items:center;gap:5px;padding:7px 12px;background:rgba(17,24,39,.97);border-bottom:1px solid var(--bd);flex-wrap:wrap}
.fbar-l{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:var(--tx3);margin-right:3px}
.fc{padding:2px 9px;border-radius:12px;font-size:10px;font-weight:600;cursor:pointer;border:1px solid var(--bd2);background:var(--s2);color:var(--tx2);transition:all .1s}
.fc.on{border-color:var(--ac);background:var(--ac-d);color:var(--tx)}

/* OD flow animation */
.odf{stroke-dasharray:5 3;animation:fa .9s linear infinite}
@keyframes fa{to{stroke-dashoffset:-16}}

/* Legend */
.leg{position:absolute;bottom:12px;left:12px;background:rgba(6,12,19,.9);border:1px solid var(--bd);border-radius:var(--r);padding:10px 12px;backdrop-filter:blur(8px)}
.leg-t{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);margin-bottom:7px}
.leg-i{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--tx2);margin-bottom:3px}
.leg-d{width:7px;height:7px;border-radius:50%}
.leg-sep{height:1px;background:var(--bd);margin:5px 0}
.leg-ln{display:flex;align-items:center;gap:5px;font-size:10px;color:var(--tx2);margin-bottom:3px}
.leg-lnd{width:16px;height:2px;border-radius:1px}

/* Source tags on map */
.srctags{position:absolute;bottom:12px;right:215px;display:flex;gap:6px;flex-wrap:wrap}
.stag{font-size:8px;font-family:'JetBrains Mono',monospace;font-weight:700;padding:2px 6px;border-radius:3px;border:1px solid;text-transform:uppercase}
.stag.r{color:#22c55e;border-color:rgba(34,197,94,.3);background:rgba(22,163,74,.08)}
.stag.s{color:var(--gd);border-color:rgba(202,138,4,.3);background:rgba(202,138,4,.07)}
.stag.h{color:#c084fc;border-color:rgba(192,132,252,.3);background:rgba(192,132,252,.06)}

/* ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ */
.kpis{display:grid;grid-template-columns:repeat(4,1fr);background:var(--s1);border-top:1px solid var(--bd);min-height:118px}
.kpi{padding:11px 13px;border-right:1px solid var(--bd);position:relative;overflow:hidden}
.kpi:last-child{border-right:none}
.kpi-ac{position:absolute;top:0;left:0;width:3px;height:100%}
.kpi-l{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);margin-bottom:7px}
.kpi-v{font-family:'Instrument Serif',serif;font-size:26px;color:var(--tx);line-height:1;margin-bottom:3px;transition:all .3s}
.kpi-d{font-size:10px;font-weight:500;display:flex;align-items:center;gap:3px;font-family:'JetBrains Mono',monospace}
.kpi-d.up{color:var(--tl)}.kpi-d.dn{color:#f87171}.kpi-d.nu{color:var(--tx3)}
.kpi-s{font-size:8px;color:var(--tx3);margin-top:4px;font-family:'JetBrains Mono',monospace;display:flex;align-items:center;gap:3px}
@keyframes kpi-in{0%{opacity:.4;transform:translateY(3px)}100%{opacity:1;transform:none}}
.kpi-v.fl{animation:kpi-in .3s ease}

/* ‚îÄ‚îÄ DECOMP VIEW ‚îÄ‚îÄ */
.dv{padding:16px 20px;overflow-y:auto;flex:1}
.dv-h{display:flex;align-items:baseline;gap:10px;margin-bottom:14px}
.dv-title{font-family:'Instrument Serif',serif;font-size:22px;color:var(--tx)}
.dv-sub{font-size:11px;color:var(--tx3)}
.dptabs{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:14px}
.dpt{padding:4px 10px;border-radius:20px;border:1px solid var(--bd2);background:var(--s2);cursor:pointer;font-size:11px;color:var(--tx2);transition:all .12s;font-family:'Syne',sans-serif;font-weight:500;display:flex;align-items:center;gap:4px}
.dpt.on{border-color:var(--ac);background:var(--ac-d);color:var(--tx)}
.dpt.risk{border-color:rgba(220,38,38,.35)}
.cgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:840px}
.ccard{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:12px 14px}
.ccard.win{border-color:var(--ac);background:var(--ac-d)}
.cc-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:9px}
.cc-m{font-size:12px;font-weight:600;display:flex;align-items:center;gap:5px}
.cc-tot{font-family:'JetBrains Mono',monospace;font-size:14px;font-weight:600}
.cc-r{display:flex;justify-content:space-between;align-items:flex-start;padding:4px 0;border-bottom:1px solid var(--bd);font-size:11px;gap:8px}
.cc-r:last-of-type{border-bottom:none}
.cc-k{color:var(--tx2);display:flex;flex-direction:column;gap:1px}
.cc-f{font-family:'JetBrains Mono',monospace;font-size:8px;color:var(--tx3)}
.cc-rv{font-family:'JetBrains Mono',monospace;color:var(--tx);flex-shrink:0}
.cc-bar{height:2px;background:var(--bd);border-radius:1px;margin-top:2px}
.cc-bar-f{height:100%;border-radius:1px}
.cc-fml{margin-top:7px;padding:7px;background:var(--s2);border-radius:var(--rs);font-family:'JetBrains Mono',monospace;font-size:9px;color:var(--tx3);line-height:1.7}

/* ‚îÄ‚îÄ COMPARE VIEW ‚îÄ‚îÄ */
.cpv{display:grid;grid-template-columns:1fr 1fr;flex:1;overflow:hidden}
.cpc{overflow-y:auto;padding:13px;border-right:1px solid var(--bd)}
.cpc:last-child{border-right:none}
.cpc-h{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);margin-bottom:9px;padding-bottom:7px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:5px}
.zc{background:var(--s1);border:1px solid var(--bd);border-radius:var(--rs);padding:9px 11px;margin-bottom:6px}
.zc-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px}
.zc-n{font-size:12px;font-weight:600;color:var(--tx)}
.zcb{font-size:8px;font-family:'JetBrains Mono',monospace;font-weight:700;padding:2px 6px;border-radius:3px;text-transform:uppercase}
.zcb.v{background:var(--gn-d);color:#4ade80}
.zcb.o{background:var(--or-d);color:#fbbf24}
.zcb.r{background:var(--rd-d);color:#f87171}
.zmets{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px}
.zm{text-align:center}
.zmv{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:500;color:var(--tx)}
.zml{font-size:8px;color:var(--tx3);margin-top:1px}

/* ‚îÄ‚îÄ NARRATIVE ‚îÄ‚îÄ */
.nvw{padding:18px 22px;overflow-y:auto;flex:1}
.nv-title{font-family:'Instrument Serif',serif;font-size:24px;color:var(--tx);margin-bottom:3px;letter-spacing:-.4px}
.nv-meta{font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace;margin-bottom:18px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.nhl{background:var(--s2);border-left:3px solid;padding:10px 13px;border-radius:0 var(--rs) var(--rs) 0;margin-bottom:13px;max-width:640px}
.nhl.ac{border-left-color:var(--ac)}.nhl.gn{border-left-color:var(--gn)}.nhl.or{border-left-color:var(--or)}.nhl.rd{border-left-color:var(--rd)}
.nhl-t{font-size:9px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--tx3);margin-bottom:4px}
.nhl-b{font-size:12px;color:var(--tx2);line-height:1.65}
.nhl-b strong{color:var(--tx);font-weight:600}
.nb{margin-bottom:14px;max-width:640px}
.nb-t{font-size:9px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--tx3);margin-bottom:7px}
.nmsr{display:flex;align-items:center;gap:7px;padding:6px 9px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);font-size:11px;margin-bottom:4px}
.nmsr-e{font-size:15px}.nmsr-l{color:var(--tx);font-weight:500;flex:1;font-size:11px}
.nmsr-fr{color:var(--tx3);text-decoration:line-through;font-size:10px}
.nmsr-to{color:var(--tl);font-weight:600;font-size:10px}
.nmsr-d{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600}
.nrec{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:11px 13px;margin-bottom:6px;max-width:640px}
.nrec-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.nrec-t{font-size:12px;font-weight:600;color:var(--tx)}
.pb{font-size:8px;font-family:'JetBrains Mono',monospace;font-weight:700;padding:2px 6px;border-radius:3px;text-transform:uppercase}
.pb.hi{background:var(--rd-d);color:#f87171;border:1px solid rgba(220,38,38,.25)}
.pb.mi{background:var(--or-d);color:#fbbf24;border:1px solid rgba(217,119,6,.25)}
.pb.lo{background:var(--gn-d);color:#4ade80;border:1px solid rgba(22,163,74,.25)}
.nrec-b{font-size:11px;color:var(--tx2);line-height:1.6}
.ndisc{margin-top:18px;padding-top:12px;border-top:1px solid var(--bd);font-size:9px;color:var(--tx3);font-family:'JetBrains Mono',monospace;max-width:640px;line-height:1.7}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.modal{position:fixed;inset:0;z-index:300;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);backdrop-filter:blur(3px)}
.modal.open{display:flex}
.mc{background:var(--s1);border:1px solid var(--bd2);border-radius:var(--r);padding:18px;width:420px;max-width:90vw;box-shadow:0 20px 60px rgba(0,0,0,.6)}
.mc.wide{width:500px}
.mcl{float:right;background:none;border:none;color:var(--tx3);cursor:pointer;font-size:15px}
.mc-em{font-size:25px;display:block;margin-bottom:6px}
.mc-n{font-family:'Instrument Serif',serif;font-size:20px;color:var(--tx);margin-bottom:2px}
.mc-desc{font-size:10px;color:var(--tx3);font-family:'JetBrains Mono',monospace;margin-bottom:11px}
.mc-row{display:flex;justify-content:space-between;font-size:11px;padding:5px 0;border-bottom:1px solid var(--bd);gap:10px}
.mc-row:last-child{border-bottom:none}
.mc-k{color:var(--tx2)}.mc-v{font-family:'JetBrains Mono',monospace;color:var(--tx);text-align:right}
.mc-foot{font-size:9px;color:var(--tx3);border-top:1px solid var(--bd);padding-top:8px;margin-top:8px;font-family:'JetBrains Mono',monospace;line-height:1.6}
.tt-mbody{font-size:11px;color:var(--tx2);line-height:1.7;margin-top:9px}
.code-block{background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);padding:9px 11px;font-family:'JetBrains Mono',monospace;font-size:9px;color:#86efac;margin:8px 0;line-height:1.8;white-space:pre-wrap;word-break:break-all}
.wbtn{padding:6px 13px;background:var(--ac);color:#fff;border:none;border-radius:5px;font-family:'Syne',sans-serif;font-size:11px;font-weight:600;cursor:pointer}
.gbtn{padding:6px 13px;background:var(--s3);color:var(--tx2);border:1px solid var(--bd);border-radius:5px;font-family:'Syne',sans-serif;font-size:11px;cursor:pointer;margin-left:6px}
.warn-box{background:var(--or-d);border:1px solid rgba(217,119,6,.25);border-radius:5px;padding:8px 10px;margin-top:9px;font-size:10px;color:#fbbf24;font-family:'JetBrains Mono',monospace;line-height:1.6}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="brand">
    <div class="brand-mark">‚üÅ</div>
    <div>
      <div class="brand-name">MobilityPricing</div>
      <div class="brand-city">Sion ¬∑ Valais CH</div>
    </div>
  </div>
  <span class="beta">B√™ta</span>
  <span class="lab">‚ú¶ powered by MobilityLab Sion</span>
  <div class="hdr-sep"></div>
  <div class="dq-bar">
    <span class="dq real" title="Tarifs: Planta 3CHF/h, Scex 3CHF/h, Roches-Brunes 2CHF/h ‚Äî source: sion.ch PDFs 2024-2025">‚úì Tarifs r√©els</span>
    <span class="dq real" title="Planta 570, Scex 658, Roches-Brunes 370 places ‚Äî source: sion.ch + Le Nouvelliste 2019">‚úì Capacit√©s r√©elles</span>
    <span class="dq sim"  title="Flux OD pendulaires estim√©s par distance √ó population ‚Äî calibration TomTom Move requise">‚ö† Flux OD estim√©s</span>
    <span class="dq hyp"  title="√âlasticit√©s, VOT, softmax ‚Äî litt√©rature acad√©mique EU/CH">‚ö† Mod√®le hypoth√©tique</span>
    <span class="dq live" onclick="openTTModal()" title="Cliquer: guide int√©gration TomTom Workers">‚óé TomTom non connect√©</span>
  </div>
  <div class="sp"></div>
  <div class="tt-btn" onclick="openTTModal()">
    <div class="tt-dot" id="ttdot"></div>
    <span id="ttlbl">TomTom Traffic</span>
  </div>
  <div style="width:8px"></div>
  <div class="mode-tog">
    <button class="mbtn on" onclick="setMode('simple',this)">D√©cideur</button>
    <button class="mbtn"    onclick="setMode('expert',this)">Expert</button>
  </div>
</header>

<!-- APP -->
<div class="app mode-simple" id="app">

<!-- ‚ïê‚ïê LEFT ‚ïê‚ïê -->
<div class="left">

  <div class="sctabs" style="padding-top:6px">
    <button class="stab on" onclick="loadSc('actuel',this)">Actuel</button>
    <button class="stab"    onclick="loadSc('modere',this)">Mod√©r√©</button>
    <button class="stab"    onclick="loadSc('ambitieux',this)">Ambitieux</button>
    <button class="stab"    onclick="loadSc('custom',this)">Perso.</button>
  </div>

  <!-- Price Impact Panel -->
  <div class="ps">
    <div class="pst"><div class="pst-d" style="background:var(--ac)"></div>Effet prix ‚Äî Centre-ville</div>
    <div class="pip">
      <div class="pip-h">Chaque +1.00 CHF/h entra√Æne‚Ä¶</div>
      <div class="pip-r"><span class="pip-k">‚ñº Report modal voiture</span><span class="pip-v g" id="pip-m">‚Äî</span></div>
      <div class="pip-r"><span class="pip-k">‚ñ≤ Recettes parking /j</span><span class="pip-v g" id="pip-r">‚Äî</span></div>
      <div class="pip-r"><span class="pip-k">‚ñ≤ Risques √©quit√©</span><span class="pip-v o" id="pip-e">‚Äî</span></div>
      <div class="pip-n" id="pip-n">‚Äî</div>
    </div>

    <!-- Real parking cards -->
    <div class="pst" style="margin-bottom:7px"><div class="pst-d" style="background:var(--gn)"></div>Parkings Sion ‚Äî donn√©es officielles</div>
    <div class="pcards">
      <div class="pcard" id="pcard-planta" onclick="selPark('planta')">
        <div class="pc-dot" style="background:#dc2626"></div>
        <div class="pc-inf">
          <div class="pc-n">Parking de la Planta</div>
          <div class="pc-d">570 pl. ¬∑ Place du Midi ¬∑ <span style="color:var(--tl)">1h gratuite</span></div>
        </div>
        <div><div class="pc-pr">3.00 CHF/h</div><div class="pc-src">sion.ch ¬∑ 15.07.2024</div></div>
      </div>
      <div class="pcard" id="pcard-scex" onclick="selPark('scex')">
        <div class="pc-dot" style="background:#ea580c"></div>
        <div class="pc-inf">
          <div class="pc-n">Parking du Scex</div>
          <div class="pc-d">658 pl. ¬∑ Rue du Scex 12 ¬∑ <span style="color:var(--tl)">1h gratuite</span></div>
        </div>
        <div><div class="pc-pr">3.00 CHF/h</div><div class="pc-src">sion.ch ¬∑ 11.08.2025</div></div>
      </div>
      <div class="pcard xo" id="pcard-roches" onclick="selPark('roches')">
        <div class="pc-dot" style="background:#d97706"></div>
        <div class="pc-inf">
          <div class="pc-n">Roches-Brunes</div>
          <div class="pc-d">370 pl. ¬∑ Av. de Tourbillon ¬∑ <span style="color:var(--tl)">1h gratuite</span></div>
        </div>
        <div><div class="pc-pr">2.00 CHF/h</div><div class="pc-src">sion.ch ¬∑ 15.07.2024</div></div>
      </div>
      <div class="pcard xo">
        <div class="pc-dot" style="background:#16a34a"></div>
        <div class="pc-inf">
          <div class="pc-n">St-Gu√©rin</div>
          <div class="pc-d">66 pl. ¬∑ <span style="color:var(--tl)">1h gratuite</span></div>
        </div>
        <div><div class="pc-pr">2.00 CHF/h</div><div class="pc-src">sion.ch ¬∑ 15.07.2024</div></div>
      </div>
      <div class="pcard xo">
        <div class="pc-dot" style="background:#7c3aed"></div>
        <div class="pc-inf">
          <div class="pc-n">Horodateurs Zone 1</div>
          <div class="pc-d">Hypercentre ¬∑ max 90 min ¬∑ Gratuit dim.</div>
        </div>
        <div><div class="pc-pr">2.00 CHF/h</div><div class="pc-src">sion.ch ¬∑ mars 2025</div></div>
      </div>
      <div class="pcard xo">
        <div class="pc-dot" style="background:#0891b2"></div>
        <div class="pc-inf">
          <div class="pc-n">Horodateurs Zone 2/3</div>
          <div class="pc-d">Centre + p√©riph√©rie ¬∑ max 5‚Äì10h</div>
        </div>
        <div><div class="pc-pr">1.50 CHF/h</div><div class="pc-src">sion.ch ¬∑ mars 2025</div></div>
      </div>
    </div>

    <div class="sg">
      <div class="sg-h"><span class="sg-l">Simulation tarif pointe (Planta/Scex)</span><span class="sg-v" id="v-pk">3.00 CHF/h</span></div>
      <div class="sg-s"><div class="sd" style="background:#22c55e"></div>R√©el actuel : 3.00 CHF/h (07h30‚Äì19h) ‚Äî source: sion.ch 2025</div>
      <input type="range" id="sl-pk" min="0" max="10" step="0.5" value="3" oninput="slU(this,'v-pk','CHF/h');simNow()">
    </div>
    <div class="sg xo">
      <div class="sg-h"><span class="sg-l">Tarif creux / hors-pointe</span><span class="sg-v" id="v-op">1.50 CHF/h</span></div>
      <div class="sg-s"><div class="sd" style="background:#22c55e"></div>R√©el actuel : ~1.50 CHF/h (nuit, dimanches) ‚Äî source: sion.ch</div>
      <input type="range" id="sl-op" min="0" max="5" step="0.5" value="1.5" oninput="slU(this,'v-op','CHF/h');simNow()">
    </div>
    <div class="sg xo">
      <div class="sg-h"><span class="sg-l">Progressivit√© apr√®s 1h</span><span class="sg-v" id="v-pg">√ó1.00</span></div>
      <div class="sg-s"><div class="sd" style="background:#c084fc"></div>Hypoth√®se ‚Äî pas encore en vigueur √† Sion</div>
      <input type="range" id="sl-pg" min="1" max="3" step="0.25" value="1" oninput="slM(this,'v-pg');simNow()">
    </div>
  </div>

  <!-- TP + P+R -->
  <div class="ps">
    <div class="pst"><div class="pst-d" style="background:var(--tl)"></div>Transports publics & P+R</div>
    <div class="sg">
      <div class="sg-h"><span class="sg-l">Rabais TP hors-pointe</span><span class="sg-v" id="v-td">0%</span></div>
      <div class="sg-s"><div class="sd" style="background:var(--gd)"></div>Billet moyen Sion-r√©gion ~3.80 CHF ‚Äî proxy CFF/CarPostal 2024</div>
      <input type="range" id="sl-td" min="0" max="50" step="5" value="0" oninput="slU(this,'v-td','%');simNow()">
    </div>
    <div class="sg xo">
      <div class="sg-h"><span class="sg-l">Prix P+R p√©riph√©rie</span><span class="sg-v" id="v-pr">0.00 CHF/h</span></div>
      <div class="sg-s"><div class="sd" style="background:var(--gd)"></div>P+R en cours de d√©ploiement ‚Äî strat√©gie Ville Sion 2024</div>
      <input type="range" id="sl-pr" min="0" max="3" step="0.25" value="0" oninput="slU(this,'v-pr','CHF/h');simNow()">
    </div>
    <div class="sg xo">
      <div class="sg-h"><span class="sg-l">Bonus P+R + TP combin√©</span><span class="sg-v" id="v-pb">0 CHF</span></div>
      <div class="sg-s"><div class="sd" style="background:#c084fc"></div>Hypoth√®se ‚Äî levier innovant (type Berne, Lausanne)</div>
      <input type="range" id="sl-pb" min="0" max="5" step="0.5" value="0" oninput="slU(this,'v-pb','CHF');simNow()">
    </div>
  </div>

  <!-- Mesures comp. -->
  <div class="ps">
    <div class="pst"><div class="pst-d" style="background:#c084fc"></div>Mesures compl√©mentaires</div>
    <div class="tr">
      <div class="tr-i"><div class="tr-n">Covoiturage dynamique <span class="pill new">nouveau</span></div><div class="tr-d">Matching pendulaires ¬∑ ‚àí40% co√ªt voiture (horaires flexibles)</div></div>
      <label class="tog"><input type="checkbox" id="tog-cv" onchange="simNow()"><div class="tok"></div><div class="tth"></div></label>
    </div>
    <div class="tr">
      <div class="tr-i"><div class="tr-n">Transport √† la Demande</div><div class="tr-d">Rabattement TP ¬∑ 2.50 CHF + 0.35/km ¬∑ zones p√©riph√©riques mal desservies</div></div>
      <label class="tog"><input type="checkbox" id="tog-td" onchange="simNow()"><div class="tok"></div><div class="tth"></div></label>
    </div>
    <div class="tr">
      <div class="tr-i"><div class="tr-n">Taxi-bons √©quit√© <span class="pill eq">√©quit√©</span></div><div class="tr-d">Seniors ¬∑ PMR ¬∑ horaires atypiques ¬∑ valeur 8 CHF/bon</div></div>
      <label class="tog"><input type="checkbox" id="tog-tx" onchange="simNow()"><div class="tok"></div><div class="tth"></div></label>
    </div>
    <div class="tr xo">
      <div class="tr-i"><div class="tr-n">30 min gratuites conditionnelles <span class="pill new">nouveau</span></div><div class="tr-d">Gratuit√© si achat local valid√© ‚Äî prot√®ge le commerce de proximit√©</div></div>
      <label class="tog"><input type="checkbox" id="tog-f3" onchange="simNow()"><div class="tok"></div><div class="tth"></div></label>
    </div>
    <div class="tr xo">
      <div class="tr-i"><div class="tr-n">Budget mobilit√© mensuel <span class="pill new">nouveau</span></div><div class="tr-d">Cr√©dit 50 CHF/mois convertible TP / v√©lo / TAD</div></div>
      <label class="tog"><input type="checkbox" id="tog-bd" onchange="simNow()"><div class="tok"></div><div class="tth"></div></label>
    </div>
    <div class="tr xo">
      <div class="tr-i"><div class="tr-n">Tarification congestive <span class="pill live">TomTom</span></div><div class="tr-d">Prix index√© congestion temps r√©el ‚Äî requiert API TomTom Traffic Flow</div></div>
      <label class="tog"><input type="checkbox" id="tog-dyn" onchange="simNow()"><div class="tok"></div><div class="tth"></div></label>
    </div>
  </div>

  <!-- Hypoth√®ses -->
  <div class="ps xo">
    <div class="pst"><div class="pst-d" style="background:var(--tx3)"></div>Transparence mod√®le ¬∑ Hypoth√®ses</div>
    <div class="hyp-tog" onclick="this.nextElementSibling.classList.toggle('open');this.querySelector('.ha').textContent=this.nextElementSibling.classList.contains('open')?'‚ñ≤':'‚ñº'">
      <span style="color:var(--tl)">‚óè</span> Sources & param√®tres <span class="ha">‚ñº</span>
    </div>
    <div class="hyp-body">
      <div class="hi real">R√âEL ‚Äî Planta / Scex : 3.00 CHF/h (07h30‚Äì19h), 1√®re h gratuite, 12h‚Äì13h30 gratuit ‚Äî sion.ch PDFs juil.2024 / ao√ªt 2025</div>
      <div class="hi real">R√âEL ‚Äî Roches-Brunes : 370 pl., 2.00 CHF/h, 1√®re h gratuite ‚Äî sion.ch 15.07.2024</div>
      <div class="hi real">R√âEL ‚Äî St-Gu√©rin : 66 pl., 2.00 CHF/h ‚Äî sion.ch 15.07.2024</div>
      <div class="hi real">R√âEL ‚Äî Zone horodateur 1 (hypercentre) : 2.00 CHF/h, max 90 min ‚Äî sion.ch mars 2025</div>
      <div class="hi real">R√âEL ‚Äî Zones 2/3 (centre/p√©riph√©rie) : 1.50 CHF/h, max 5‚Äì10h ‚Äî sion.ch mars 2025</div>
      <div class="hi real">R√âEL ‚Äî Abo. pendulaire Planta/Scex : 160 CHF/mois ‚Äî sion.ch juil.2024</div>
      <div class="hi real">R√âEL ‚Äî Total places publiques Sion : ~2 600 ‚Äî Le Nouvelliste 12.11.2019</div>
      <div class="hi">SIM ‚Äî Flux OD : estim√©s distance√ópopulation (TomTom Move requis pour calibration)</div>
      <div class="hi">HYP ‚Äî √âlasticit√© parking : ‚àí0.30 (Shoup 2005 + m√©ta-analyses EU 2020‚Äì23)</div>
      <div class="hi">HYP ‚Äî Softmax temp. = 0.60 (Hess et al. 2017, DCM transport suisse)</div>
      <div class="hi">HYP ‚Äî VOT : 12‚Äì38 CHF/h par profil (DETEC 2018, ajust√© Valais)</div>
      <div class="hi">HYP ‚Äî Co√ªt km auto marginal : 0.18 CHF (TCS 2023)</div>
      <div class="hi">HYP ‚Äî Billet TP Sion-r√©gion : ~3.80 CHF (proxy CFF/CarPostal 2024)</div>
      <div class="hi">HYP ‚Äî TAD : 2.50 CHF base + 0.35 CHF/km (pilotes TAD romands 2022‚Äì23)</div>
      <div class="hr">R√©f: sion.ch (2024‚Äì25) ¬∑ Le Nouvelliste (2019) ¬∑ DETEC (2018) ¬∑ TCS (2023) ¬∑ Shoup (2005) ¬∑ Hess et al. (2017) ¬∑ Litt√©rature DCM CH</div>
    </div>
  </div>

  <!-- Equity alert -->
  <div class="ps">
    <div class="eq-p" id="eq-p">
      <div class="eq-t">‚ö† Risque √©quit√© d√©tect√©</div>
      <div class="eq-b" id="eq-b">‚Äî</div>
    </div>
  </div>

  <!-- Personas -->
  <div class="ps">
    <div class="pst"><div class="pst-d" style="background:#c084fc"></div>Impact ‚Äî 12 profils types ¬∑ cliquer pour d√©tail</div>
    <div class="pstrip" id="pstrip"></div>
  </div>

</div><!-- /left -->

<!-- ‚ïê‚ïê RIGHT ‚ïê‚ïê -->
<div class="right">
  <div class="vtabs">
    <button class="vt on" onclick="swV('map',this)">üó∫ Carte OD</button>
    <button class="vt"    onclick="swV('decomp',this)">‚äû Co√ªts d√©compos√©s</button>
    <button class="vt"    onclick="swV('compare',this)">‚áÑ Comparaison</button>
    <button class="vt"    onclick="swV('narrative',this)">‚óé Synth√®se</button>
  </div>

  <!-- MAP VIEW -->
  <div class="view on" id="view-map">
    <div class="fbar">
      <span class="fbar-l">Flux OD :</span>
      <button class="fc on" data-f="all"    onclick="setF('all',this)">Tous</button>
      <button class="fc"    data-f="pend"   onclick="setF('pend',this)">Pendulaire</button>
      <button class="fc"    data-f="emploi" onclick="setF('emploi',this)">Emploi</button>
      <button class="fc"    data-f="pr"     onclick="setF('pr',this)">P+R</button>
    </div>

    <div class="mapw" id="mapw">
      <svg class="msvg" viewBox="0 0 790 400" preserveAspectRatio="xMidYMid meet">
        <defs>
          <radialGradient id="bgG" cx="42%" cy="38%">
            <stop offset="0%" stop-color="#122438"/>
            <stop offset="100%" stop-color="#080f1c"/>
          </radialGradient>
          <filter id="glow">
            <feGaussianBlur stdDeviation="3" result="b"/>
            <feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
          <marker id="ab" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0L0,7L7,3.5z" fill="rgba(59,130,246,.7)"/></marker>
          <marker id="ap" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0L0,7L7,3.5z" fill="rgba(139,92,246,.7)"/></marker>
          <marker id="at" markerWidth="7" markerHeight="7" refX="6" refY="3.5" orient="auto"><path d="M0,0L0,7L7,3.5z" fill="rgba(20,184,166,.7)"/></marker>
        </defs>

        <!-- Background -->
        <rect width="790" height="400" fill="url(#bgG)"/>

        <!-- Valley topography contours -->
        <g opacity="0.04" fill="none" stroke="#5090b0" stroke-width=".7">
          <ellipse cx="395" cy="200" rx="385" ry="175"/><ellipse cx="395" cy="200" rx="340" ry="148"/>
          <ellipse cx="395" cy="200" rx="295" ry="120"/><ellipse cx="395" cy="200" rx="248" ry="92"/>
          <ellipse cx="395" cy="200" rx="198" ry="65"/>
        </g>

        <!-- Rh√¥ne valley floor -->
        <ellipse cx="395" cy="222" rx="390" ry="90" fill="#0c1f30" opacity="0.4"/>

        <!-- Rh√¥ne river ‚Äî realistic Valais path -->
        <path d="M0,226 C70,218 140,224 210,220 C280,216 320,222 375,220 C430,218 490,223 560,220 C630,217 710,222 790,218" fill="none" stroke="#0d3d5e" stroke-width="24" opacity="0.9"/>
        <path d="M0,226 C70,218 140,224 210,220 C280,216 320,222 375,220 C430,218 490,223 560,220 C630,217 710,222 790,218" fill="none" stroke="#1a6080" stroke-width="7" opacity="0.45"/>
        <path d="M0,226 C70,218 140,224 210,220 C280,216 320,222 375,220 C430,218 490,223 560,220 C630,217 710,222 790,218" fill="none" stroke="#226a90" stroke-width="1.5" opacity="0.3"/>
        <text x="670" y="210" fill="#1a4a6a" font-size="9" font-family="Syne" font-weight="700" opacity=".8" letter-spacing=".15em">RH√îNE</text>

        <!-- A9 autoroute -->
        <path d="M0,238 C160,235 300,240 395,237 C490,234 650,239 790,236" fill="none" stroke="#1a1a06" stroke-width="10"/>
        <path d="M0,238 C160,235 300,240 395,237 C490,234 650,239 790,236" fill="none" stroke="#3a3a10" stroke-width="3" stroke-dasharray="20,8" opacity=".85"/>
        <text x="715" y="228" fill="#3a3a12" font-size="8" font-family="Syne" font-weight="700">A9 / E62</text>

        <!-- Mountain silhouettes (Val√®re + Tourbillon) -->
        <path d="M305,183 Q332,145 358,156 Q374,148 392,161 Q406,152 425,164 Q440,155 458,165 Q470,205 455,215 Q420,218 380,215 Q340,218 318,212 Z" fill="#0c1e2e" opacity="0.4"/>
        <path d="M428,178 Q450,140 467,150 Q480,142 494,153 Q507,145 520,157 Q532,162 538,178 Q526,200 502,204 Q476,207 455,203 Q440,197 432,188 Z" fill="#0c1e28" opacity="0.35"/>

        <!-- Road schematic (Grand-Pont axis) -->
        <g fill="none" stroke="#1e3048" stroke-width="1.5" opacity="0.5">
          <line x1="240" y1="198" x2="530" y2="198"/>
          <line x1="364" y1="186" x2="364" y2="222"/>
          <line x1="294" y1="198" x2="294" y2="220"/>
          <line x1="290" y1="215" x2="475" y2="215"/>
        </g>

        <!-- OD FLOWS (JS-generated) -->
        <g id="odg"></g>

        <!-- ‚ïê‚ïê‚ïê SION ZONES ‚ïê‚ïê‚ïê -->

        <!-- Zone Emploi Est ‚Äî CERM, HES-SO, Zone industrielle -->
        <g id="zone-emploi" class="zone-g" data-zone="emploi" onclick="selZone('emploi')">
          <ellipse cx="548" cy="196" rx="72" ry="40" fill="#221444" class="zf" opacity=".9"/>
          <ellipse cx="548" cy="196" rx="72" ry="40" fill="#8b5cf6" opacity=".05"/>
          <rect x="476" y="156" width="144" height="80" rx="8" fill="transparent" stroke="#8b5cf6" stroke-width="1" opacity=".5"/>
          <text x="548" y="191" text-anchor="middle" font-size="10" font-weight="700" fill="#8b5cf6" font-family="Syne">Zone Emploi Est</text>
          <text x="548" y="204" text-anchor="middle" font-size="8" fill="#5a3a8a" font-family="Syne">CERM ¬∑ HES-SO ¬∑ Industrie</text>
        </g>

        <!-- Gare CFF -->
        <g id="zone-gare" class="zone-g" data-zone="gare" onclick="selZone('gare')">
          <rect x="264" y="196" width="68" height="46" rx="6" fill="#221c00" class="zf" opacity=".95"/>
          <rect x="264" y="196" width="68" height="46" rx="6" fill="#f59e0b" opacity=".07"/>
          <rect x="264" y="196" width="68" height="46" rx="6" stroke="#f59e0b" stroke-width="1.2" fill="none" opacity=".5"/>
          <text x="298" y="218" text-anchor="middle" font-size="11" font-weight="700" fill="#f59e0b" font-family="Syne">Gare CFF</text>
          <text x="298" y="231" text-anchor="middle" font-size="8" fill="#8a6010" font-family="Syne">p√¥le multimodal</text>
        </g>

        <!-- Centre-ville (Place du Midi, Vieille Ville) -->
        <g id="zone-centre" class="zone-g" data-zone="centre" onclick="selZone('centre')">
          <rect x="322" y="178" width="104" height="60" rx="7" fill="#2a1010" class="zf" opacity=".95"/>
          <rect x="322" y="178" width="104" height="60" rx="7" fill="#dc2626" opacity=".08"/>
          <rect x="322" y="178" width="104" height="60" rx="7" stroke="#dc2626" stroke-width="1.8" fill="none" opacity=".7"/>
          <text x="374" y="203" text-anchor="middle" font-size="12" font-weight="700" fill="#ef4444" font-family="Syne" filter="url(#glow)">Centre-ville</text>
          <text x="374" y="216" text-anchor="middle" font-size="8" fill="#7a2020" font-family="Syne">Vieille Ville ¬∑ Place du Midi</text>
          <text x="374" y="228" text-anchor="middle" font-size="8" fill="#5a1818" font-family="Syne">Zone horo. 1 ¬∑ 2 CHF/h</text>
        </g>

        <!-- R√©sidentiel Nord -->
        <g id="zone-nord" class="zone-g" data-zone="nord" onclick="selZone('nord')">
          <rect x="342" y="143" width="74" height="31" rx="5" fill="#18221a" class="zf" opacity=".9"/>
          <rect x="342" y="143" width="74" height="31" rx="5" stroke="#65a30d" stroke-width="1" fill="none" opacity=".4"/>
          <text x="379" y="157" text-anchor="middle" font-size="9" font-weight="600" fill="#65a30d" font-family="Syne">R√©sidentiel Nord</text>
          <text x="379" y="168" text-anchor="middle" font-size="8" fill="#3d6008" font-family="Syne">Zone 3 ¬∑ 1.50 CHF/h</text>
        </g>

        <!-- P+R Ouest (en projet) -->
        <g id="zone-pr" class="zone-g" data-zone="pr" onclick="selZone('pr')">
          <rect x="194" y="200" width="64" height="30" rx="5" fill="#0e2428" class="zf" opacity=".9"/>
          <rect x="194" y="200" width="64" height="30" rx="5" stroke="#0d9488" stroke-width="1.5" fill="none" opacity=".6"/>
          <text x="226" y="215" text-anchor="middle" font-size="9" font-weight="700" fill="#0d9488" font-family="Syne">P+R Ouest</text>
          <text x="226" y="225" text-anchor="middle" font-size="7" fill="#0a5048" font-family="Syne">(en projet)</text>
        </g>

        <!-- ‚ïê‚ïê‚ïê COMMUNES P√âRIPH√âRIQUES ‚ïê‚ïê‚ïê -->
        <g id="zone-saviese" class="zone-g" data-zone="saviese" onclick="selZone('saviese')">
          <ellipse cx="148" cy="146" rx="66" ry="44" fill="#122212" opacity=".9" class="zf"/>
          <ellipse cx="148" cy="146" rx="66" ry="44" stroke="#16a34a" stroke-width="1.2" fill="none" opacity=".5"/>
          <text x="148" y="141" text-anchor="middle" font-size="12" font-weight="700" fill="#4ade80" font-family="Syne">Savi√®se</text>
          <text x="148" y="155" text-anchor="middle" font-size="8" fill="#2d8a4a" font-family="Syne">7 000 hab. ¬∑ 22 min TP</text>
        </g>

        <g id="zone-conthey" class="zone-g" data-zone="conthey" onclick="selZone('conthey')">
          <ellipse cx="80" cy="217" rx="58" ry="36" fill="#122212" opacity=".9" class="zf"/>
          <ellipse cx="80" cy="217" rx="58" ry="36" stroke="#16a34a" stroke-width="1.2" fill="none" opacity=".5"/>
          <text x="80" y="212" text-anchor="middle" font-size="12" font-weight="700" fill="#4ade80" font-family="Syne">Conthey</text>
          <text x="80" y="226" text-anchor="middle" font-size="8" fill="#2d8a4a" font-family="Syne">10 000 hab. ¬∑ 18 min TP</text>
        </g>

        <g id="zone-nendaz" class="zone-g" data-zone="nendaz" onclick="selZone('nendaz')">
          <ellipse cx="374" cy="348" rx="60" ry="36" fill="#122212" opacity=".9" class="zf"/>
          <ellipse cx="374" cy="348" rx="60" ry="36" stroke="#16a34a" stroke-width="1.2" fill="none" opacity=".5"/>
          <text x="374" y="344" text-anchor="middle" font-size="12" font-weight="700" fill="#4ade80" font-family="Syne">Nendaz</text>
          <text x="374" y="357" text-anchor="middle" font-size="8" fill="#2d8a4a" font-family="Syne">6 500 hab. ¬∑ 35 min TP</text>
        </g>

        <g id="zone-ayent" class="zone-g" data-zone="ayent" onclick="selZone('ayent')">
          <ellipse cx="562" cy="137" rx="56" ry="36" fill="#122212" opacity=".9" class="zf"/>
          <ellipse cx="562" cy="137" rx="56" ry="36" stroke="#16a34a" stroke-width="1.2" fill="none" opacity=".5"/>
          <text x="562" y="132" text-anchor="middle" font-size="12" font-weight="700" fill="#4ade80" font-family="Syne">Ayent</text>
          <text x="562" y="146" text-anchor="middle" font-size="8" fill="#2d8a4a" font-family="Syne">4 500 hab. ¬∑ 28 min TP</text>
        </g>

        <g id="zone-veysonnaz" class="zone-g" data-zone="veysonnaz" onclick="selZone('veysonnaz')">
          <ellipse cx="562" cy="315" rx="48" ry="30" fill="#122212" opacity=".9" class="zf"/>
          <ellipse cx="562" cy="315" rx="48" ry="30" stroke="#16a34a" stroke-width="1" fill="none" opacity=".4"/>
          <text x="562" y="310" text-anchor="middle" font-size="10" font-weight="700" fill="#4ade80" font-family="Syne">Veysonnaz</text>
          <text x="562" y="323" text-anchor="middle" font-size="8" fill="#2d8a4a" font-family="Syne">1 200 hab. ¬∑ 32 min</text>
        </g>

        <g id="zone-riddes" class="zone-g" data-zone="riddes" onclick="selZone('riddes')">
          <ellipse cx="174" cy="318" rx="46" ry="28" fill="#122212" opacity=".85" class="zf"/>
          <ellipse cx="174" cy="318" rx="46" ry="28" stroke="#16a34a" stroke-width=".8" fill="none" opacity=".3"/>
          <text x="174" y="313" text-anchor="middle" font-size="10" font-weight="600" fill="#2d8a4a" font-family="Syne">Riddes</text>
          <text x="174" y="326" text-anchor="middle" font-size="8" fill="#1d5a32" font-family="Syne">5 500 hab. ¬∑ 25 min</text>
        </g>

        <!-- ‚ïê‚ïê‚ïê PARKING MARKERS (REAL POSITIONS) ‚ïê‚ïê‚ïê -->
        <!-- La Planta ‚Äî Place du Midi -->
        <g class="pmark" onclick="selPark('planta')" id="pm-planta">
          <circle cx="366" cy="207" r="11" fill="#dc2626" opacity=".92"/>
          <circle cx="366" cy="207" r="17" fill="#dc2626" opacity=".1"/>
          <text x="366" y="211" text-anchor="middle" font-size="11" font-weight="900" fill="white" font-family="Syne">P</text>
          <text x="366" y="225" text-anchor="middle" font-size="7" fill="#dc2626" font-family="Syne">Planta 570</text>
        </g>
        <!-- Le Scex ‚Äî Rue du Scex -->
        <g class="pmark" onclick="selPark('scex')" id="pm-scex">
          <circle cx="310" cy="208" r="11" fill="#ea580c" opacity=".92"/>
          <circle cx="310" cy="208" r="17" fill="#ea580c" opacity=".1"/>
          <text x="310" y="212" text-anchor="middle" font-size="11" font-weight="900" fill="white" font-family="Syne">P</text>
          <text x="310" y="226" text-anchor="middle" font-size="7" fill="#ea580c" font-family="Syne">Scex 658</text>
        </g>
        <!-- Roches-Brunes ‚Äî Av. de Tourbillon -->
        <g class="pmark xo" id="pm-roches">
          <circle cx="446" cy="166" r="9" fill="#d97706" opacity=".88"/>
          <text x="446" y="170" text-anchor="middle" font-size="9" font-weight="900" fill="white" font-family="Syne">P</text>
          <text x="446" y="182" text-anchor="middle" font-size="7" fill="#d97706" font-family="Syne">RB 370</text>
        </g>
        <!-- St-Gu√©rin -->
        <g class="pmark xo" id="pm-stgue">
          <circle cx="395" cy="158" r="8" fill="#16a34a" opacity=".85"/>
          <text x="395" y="162" text-anchor="middle" font-size="8" font-weight="900" fill="white" font-family="Syne">P</text>
          <text x="395" y="174" text-anchor="middle" font-size="7" fill="#16a34a" font-family="Syne">StG 66</text>
        </g>
        <!-- Gare P+Rail -->
        <g class="pmark">
          <circle cx="280" cy="215" r="7" fill="#0d9488" opacity=".85"/>
          <text x="280" y="219" text-anchor="middle" font-size="7" font-weight="900" fill="white" font-family="Syne">P</text>
          <text x="280" y="230" text-anchor="middle" font-size="7" fill="#0d9488" font-family="Syne">P+Rail</text>
        </g>

        <!-- Compass -->
        <g transform="translate(752,26)">
          <circle cx="0" cy="0" r="16" fill="#0d1826" stroke="#2a3a52" stroke-width="1"/>
          <text x="0" y="-1" text-anchor="middle" font-size="9" fill="#d8e8f8" font-family="Syne" font-weight="700">N</text>
          <polygon points="0,-11 2,-3 -2,-3" fill="#2563eb"/>
          <polygon points="0,11 2,3 -2,3" fill="#3a4a60"/>
        </g>
        <!-- Scale -->
        <g transform="translate(14,388)">
          <line x1="0" y1="0" x2="46" y2="0" stroke="#3a5070" stroke-width="2"/>
          <line x1="0" y1="-4" x2="0" y2="4" stroke="#3a5070" stroke-width="1.5"/>
          <line x1="46" y1="-4" x2="46" y2="4" stroke="#3a5070" stroke-width="1.5"/>
          <text x="23" y="11" text-anchor="middle" font-size="8" fill="#3a5070" font-family="Syne">~2 km</text>
        </g>
      </svg>

      <!-- Tooltip -->
      <div class="mtt" id="mtt">
        <div class="mtt-t" id="mtt-n">‚Äî</div>
        <div class="mtt-r"><span>Tarif actuel</span><span class="mtt-v" id="mtt-pr">‚Äî</span></div>
        <div class="mtt-r"><span>Part voiture sc√©nario</span><span class="mtt-v" id="mtt-car">‚Äî</span></div>
        <div class="mtt-r"><span>Shift modal estim√©</span><span class="mtt-v" id="mtt-sh">‚Äî</span></div>
        <div class="mtt-r"><span>√âlasticit√© /100</span><span class="mtt-v" id="mtt-el">‚Äî</span></div>
        <div class="mtt-s" id="mtt-src">‚Äî</div>
      </div>

      <!-- Mode split overlay -->
      <div class="mso">
        <div class="mso-t">R√©partition modale</div>
        <div class="mso-z" id="mso-z">Centre-ville</div>
        <div id="mso-bars"></div>
      </div>

      <!-- Source tags -->
      <div class="srctags">
        <span class="stag r">‚úì sion.ch r√©el</span>
        <span class="stag s">‚ö† OD estim√©</span>
        <span class="stag h">~ mod√®le hyp.</span>
      </div>

      <!-- Legend -->
      <div class="leg">
        <div class="leg-t">Potentiel bascule</div>
        <div class="leg-i"><div class="leg-d" style="background:#4ade80"></div>Fort (&gt;60)</div>
        <div class="leg-i"><div class="leg-d" style="background:#fbbf24"></div>Mod√©r√© (35‚Äì60)</div>
        <div class="leg-i"><div class="leg-d" style="background:#f87171"></div>Faible (&lt;35)</div>
        <div class="leg-sep"></div>
        <div class="leg-ln"><div class="leg-lnd" style="background:#3b82f6;opacity:.7"></div>Pendulaire</div>
        <div class="leg-ln"><div class="leg-lnd" style="background:#8b5cf6;opacity:.7"></div>Emploi</div>
        <div class="leg-ln"><div class="leg-lnd" style="background:#14b8a6;opacity:.7"></div>P+R</div>
        <div class="leg-sep"></div>
        <div class="leg-i" style="font-size:8px;color:var(--tx3)">P = parkings sion.ch 2024‚Äì2025</div>
      </div>
    </div><!-- /mapw -->

    <!-- KPIs -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-ac" style="background:var(--tl)"></div>
        <div class="kpi-l">Report modal voiture</div>
        <div class="kpi-v" id="kv-sh">‚Äî</div>
        <div class="kpi-d nu" id="kd-sh">Simuler pour voir</div>
        <div class="kpi-s"><span style="width:5px;height:5px;border-radius:50%;background:#c084fc;display:inline-block"></span> Softmax ¬∑ √©lasticit√© ‚àí0.3 ¬∑ HYP</div>
      </div>
      <div class="kpi">
        <div class="kpi-ac" style="background:var(--gn)"></div>
        <div class="kpi-l">Recettes parking /jour</div>
        <div class="kpi-v" id="kv-rv">‚Äî</div>
        <div class="kpi-d nu" id="kd-rv">vs tarifs actuels</div>
        <div class="kpi-s"><span style="width:5px;height:5px;border-radius:50%;background:#22c55e;display:inline-block"></span> Planta 570 + Scex 658 ¬∑ tarifs r√©els 2025</div>
      </div>
      <div class="kpi">
        <div class="kpi-ac" style="background:var(--ac)"></div>
        <div class="kpi-l">CO‚ÇÇ √©vit√© /an</div>
        <div class="kpi-v" id="kv-co">‚Äî</div>
        <div class="kpi-d nu" id="kd-co">trajectoire 2030</div>
        <div class="kpi-s"><span style="width:5px;height:5px;border-radius:50%;background:#c084fc;display:inline-block"></span> 210g CO‚ÇÇ/km ¬∑ OFEV CH ¬∑ HYP flux</div>
      </div>
      <div class="kpi">
        <div class="kpi-ac" style="background:var(--rd)"></div>
        <div class="kpi-l">Profils √† risque √©quit√©</div>
        <div class="kpi-v" id="kv-eq">‚Äî</div>
        <div class="kpi-d nu" id="kd-eq">sur 12 personas</div>
        <div class="kpi-s"><span style="width:5px;height:5px;border-radius:50%;background:#c084fc;display:inline-block"></span> Revenu faible + Œîco√ªt &gt;15% ¬∑ HYP</div>
      </div>
    </div>
  </div><!-- /view-map -->

  <!-- DECOMP VIEW -->
  <div class="view" id="view-decomp">
    <div class="dv">
      <div class="dv-h">
        <div class="dv-title">D√©composition des co√ªts</div>
        <div class="dv-sub">Chaque ligne = formule v√©rifiable ¬∑ sources visibles</div>
      </div>
      <div class="dptabs" id="dptabs"></div>
      <div class="cgrid" id="cgrid"></div>
    </div>
  </div>

  <!-- COMPARE VIEW -->
  <div class="view" id="view-compare">
    <div class="cpv">
      <div class="cpc">
        <div class="cpc-h" style="color:var(--tx3)"><span style="width:6px;height:6px;border-radius:50%;background:var(--tx3);display:inline-block"></span>Situation actuelle (tarifs r√©els)</div>
        <div id="cpb"></div>
      </div>
      <div class="cpc">
        <div class="cpc-h" style="color:var(--ac)"><span style="width:6px;height:6px;border-radius:50%;background:var(--ac);display:inline-block"></span>Sc√©nario simul√©</div>
        <div id="cps"></div>
      </div>
    </div>
  </div>

  <!-- NARRATIVE VIEW -->
  <div class="view" id="view-narrative">
    <div class="nvw" id="nvw">
      <div style="color:var(--tx3);font-size:12px;text-align:center;margin-top:80px;font-family:'JetBrains Mono',monospace;">Ajustez un param√®tre pour g√©n√©rer la synth√®se ‚Üí</div>
    </div>
  </div>
</div><!-- /right -->
</div><!-- /app -->

<!-- PERSONA MODAL -->
<div class="modal" id="mod-p" onclick="closeMod('mod-p',event)">
  <div class="mc" onclick="event.stopPropagation()">
    <button class="mcl" onclick="document.getElementById('mod-p').classList.remove('open')">‚úï</button>
    <span class="mc-em" id="mp-e">‚Äî</span>
    <div class="mc-n" id="mp-n">‚Äî</div>
    <div class="mc-desc" id="mp-d">‚Äî</div>
    <div id="mp-rows"></div>
    <div class="mc-foot" id="mp-f">‚Äî</div>
  </div>
</div>

<!-- TOMTOM MODAL -->
<div class="modal" id="mod-tt" onclick="closeMod('mod-tt',event)">
  <div class="mc wide" onclick="event.stopPropagation()">
    <button class="mcl" onclick="document.getElementById('mod-tt').classList.remove('open')">‚úï</button>
    <div style="font-family:'Instrument Serif',serif;font-size:20px;color:var(--tx);margin-bottom:4px">Int√©gration TomTom Traffic</div>
    <div class="tt-mbody">
      <strong style="color:var(--tx)">1. Ajouter la cl√© dans Cloudflare Workers</strong><br>
      Dashboard ‚Üí Workers ‚Üí <code style="color:#86efac;background:var(--s2);padding:1px 4px;border-radius:3px">sion</code> ‚Üí Settings ‚Üí <strong>Secrets</strong> (ne jamais mettre dans wrangler.toml !) :
      <div class="code-block">TOMTOM_API_KEY = "votre_cl√©_my.tomtom.com"</div>

      <strong style="color:var(--tx)">2. Route √† ajouter dans apps/worker/src/index.ts</strong>
      <div class="code-block">// GET /api/traffic/flow ‚Äî proxy TomTom Traffic Flow Sion
if (pathname === '/api/traffic/flow' && method === 'GET') {
  // Sion centre coords: 46.2333, 7.3595
  const apiUrl = 'https://api.tomtom.com/traffic/services/4'
    + '/flowSegmentData/absolute/10/json'
    + `?point=46.2333,7.3595&unit=KMPH`
    + `&key=${env.TOMTOM_API_KEY}`;
  
  const r = await fetch(apiUrl);
  const d = await r.json();
  const seg = d.flowSegmentData;
  
  return jsonResponse({
    source: 'TomTom Traffic Flow API v4',
    point: '46.2333, 7.3595',
    currentSpeed:  seg?.currentSpeed,
    freeFlowSpeed: seg?.freeFlowSpeed,
    confidence:    seg?.confidence,
    congestionIdx: seg ? Math.round(
      (1 - seg.currentSpeed / seg.freeFlowSpeed) * 100
    ) : null,
    timestamp: new Date().toISOString()
  });
}</div>

      <strong style="color:var(--tx)">3. Structure GitHub ‚Äî o√π mettre les fichiers</strong>
      <div class="code-block">MobilityLabCH/Sion/              ‚Üê repo racine
‚îú‚îÄ‚îÄ apps/
‚îÇ   ‚îú‚îÄ‚îÄ worker/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts         ‚Üê ajouter route /api/traffic/flow
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ simulator.ts     ‚Üê moteur de simulation
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ wrangler.toml        ‚Üê vars sans la cl√© API
‚îÇ   ‚îî‚îÄ‚îÄ web/
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ lib/
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ api.ts       ‚Üê ajouter fetchTrafficFlow()
‚îÇ           ‚îú‚îÄ‚îÄ components/
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ Map.tsx      ‚Üê composant carte
‚îÇ           ‚îî‚îÄ‚îÄ App.tsx
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îú‚îÄ‚îÄ parking.json             ‚Üê ‚¨Ö METTRE √Ä JOUR tarifs r√©els
‚îÇ   ‚îú‚îÄ‚îÄ zones.json               ‚Üê zones GeoJSON
‚îÇ   ‚îî‚îÄ‚îÄ personas.json
‚îú‚îÄ‚îÄ simulator/
‚îÇ   ‚îî‚îÄ‚îÄ sion-v4.html             ‚Üê ‚¨Ö CE FICHIER (prototype)
‚îî‚îÄ‚îÄ README.md</div>

      <strong style="color:var(--tx)">4. Ne jamais versionner les cl√©s</strong>
      <div class="code-block"># .gitignore
.env
.env.local
*.secret

# wrangler.toml ‚Üí PAS la cl√©, juste la bbox
[vars]
ENVIRONMENT  = "production"
TOMTOM_BBOX  = "7.33,46.20,7.40,46.25"

# Secrets ‚Üí Cloudflare Dashboard uniquement</div>

      <div class="warn-box">‚ö† Plan Evaluation TomTom (30j gratuit). Apr√®s : Traffic Flow API ~2‚Äì5 USD/1000 req.<br>Avec cache 5 min c√¥t√© Worker : &lt;20 CHF/mois pour un POC. Ajouter KV cache fortement recommand√©.</div>
    </div>
    <div style="margin-top:12px;padding-top:10px;border-top:1px solid var(--bd)">
      <button class="wbtn" onclick="testTomTom()">Tester /api/traffic/flow</button>
      <button class="gbtn" onclick="document.getElementById('mod-tt').classList.remove('open')">Fermer</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// REAL DATA ‚Äî source: sion.ch PDFs 2024‚Äì2025 + Le Nouvelliste 2019
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PARKINGS_REELS = {
  planta: { n:'Planta', pl:570, chfH:3.00, h1:true, src:'sion.ch 15.07.2024' },
  scex:   { n:'Scex',   pl:658, chfH:3.00, h1:true, src:'sion.ch 11.08.2025' },
  roches: { n:'Roches-Brunes', pl:370, chfH:2.00, h1:true, src:'sion.ch 15.07.2024' },
  stgue:  { n:'St-Gu√©rin', pl:66, chfH:2.00, h1:true, src:'sion.ch 15.07.2024' },
  // Zones horodateurs mars 2025:
  zone1:  { n:'Horo.Zone1', chfH:2.00, maxH:1.5, src:'sion.ch mars 2025' },
  zone2:  { n:'Horo.Zone2', chfH:1.50, maxH:5,   src:'sion.ch mars 2025' },
  zone3:  { n:'Horo.Zone3', chfH:1.50, maxH:10,  src:'sion.ch mars 2025' },
};
// Total public: 2600 places ‚Äî source: Le Nouvelliste 12.11.2019
// Abo pendulaire Planta/Scex: 160 CHF/mois ‚Äî source: sion.ch juil.2024

const ZONES = {
  centre:    {lbl:'Centre-ville (Planta/Scex)', price:3.0, tpMin:0,  acc:1.00, fric:0.9, src:'sion.ch 2025'},
  gare:      {lbl:'Gare CFF',                   price:2.0, tpMin:5,  acc:0.95, fric:0.65,src:'sion.ch 2025'},
  emploi:    {lbl:'Zone Emploi Est (CERM/HES)',  price:0.8, tpMin:10, acc:0.62, fric:0.25,src:'hypoth√®se'},
  nord:      {lbl:'R√©sidentiel Nord',            price:2.0, tpMin:12, acc:0.55, fric:0.2, src:'sion.ch Zone 3'},
  pr:        {lbl:"P+R Ouest (projet)",          price:0.0, tpMin:8,  acc:0.70, fric:0.1, src:'strat√©gie 2024'},
  saviese:   {lbl:'Savi√®se',                     price:0.0, tpMin:22, acc:0.35, fric:0.0, src:'estim√© dist.√ópop.'},
  conthey:   {lbl:'Conthey',                     price:0.0, tpMin:18, acc:0.42, fric:0.0, src:'estim√© dist.√ópop.'},
  nendaz:    {lbl:'Nendaz',                      price:0.0, tpMin:35, acc:0.28, fric:0.0, src:'estim√© dist.√ópop.'},
  ayent:     {lbl:'Ayent',                       price:0.0, tpMin:28, acc:0.30, fric:0.0, src:'estim√© dist.√ópop.'},
  veysonnaz: {lbl:'Veysonnaz',                   price:0.0, tpMin:32, acc:0.22, fric:0.0, src:'estim√© dist.√ópop.'},
  riddes:    {lbl:'Riddes',                      price:0.0, tpMin:25, acc:0.28, fric:0.0, src:'estim√© dist.√ópop.'},
};

const ZXY = {
  centre:{x:374,y:207},gare:{x:298,y:219},emploi:{x:548,y:196},nord:{x:379,y:158},
  pr:{x:226,y:215},saviese:{x:148,y:146},conthey:{x:80,y:217},nendaz:{x:374,y:348},
  ayent:{x:562,y:137},veysonnaz:{x:562,y:315},riddes:{x:174,y:318}
};

const FLOWS = [
  {from:'saviese',to:'centre',vol:3200,type:'pend',lbl:'3 200'},
  {from:'conthey',to:'centre',vol:4500,type:'pend',lbl:'4 500'},
  {from:'conthey',to:'emploi',vol:1800,type:'emploi',lbl:'1 800'},
  {from:'nendaz', to:'centre',vol:2100,type:'pend',lbl:'2 100'},
  {from:'ayent',  to:'centre',vol:1600,type:'pend',lbl:'1 600'},
  {from:'ayent',  to:'emploi',vol:900, type:'emploi',lbl:'900'},
  {from:'riddes', to:'centre',vol:1400,type:'pend',lbl:'1 400'},
  {from:'nord',   to:'centre',vol:2800,type:'pend',lbl:'2 800'},
  {from:'pr',     to:'centre',vol:600, type:'pr',  lbl:'600'},
  {from:'veysonnaz',to:'centre',vol:800,type:'pend',lbl:'800'},
  {from:'gare',   to:'centre',vol:1200,type:'pend',lbl:'1 200'},
];
const FC = {pend:'#3b82f6',emploi:'#8b5cf6',pr:'#14b8a6'};

const PERSONAS = [
  {id:'p1', e:'üè¢',n:'Pendulaire',       inc:'moyen', vot:28,ps:.50,sr:.80,ta:.60,cd:.70,zone:'centre',tw:'peak',  dur:'long', alts:['tp','covoit']},
  {id:'p2', e:'üõç',n:'Client commerce',  inc:'moyen', vot:22,ps:.70,sr:.20,ta:.50,cd:.50,zone:'centre',tw:'offpk', dur:'short',alts:['tp']},
  {id:'p3', e:'üë∑',n:'Ouvrier Conthey',  inc:'faible',vot:18,ps:.85,sr:.75,ta:.30,cd:.90,zone:'emploi',tw:'peak',  dur:'long', alts:['covoit']},
  {id:'p4', e:'üè•',n:'Soignante',      inc:'moyen', vot:32,ps:.40,sr:.95,ta:.40,cd:.85,zone:'centre',tw:'peak',  dur:'short',alts:['taxi']},
  {id:'p5', e:'üéì',n:'√âtudiant',          inc:'faible',vot:12,ps:.90,sr:.30,ta:.85,cd:.20,zone:'gare',  tw:'peak',  dur:'long', alts:['tp']},
  {id:'p6', e:'üë¥',n:'Senior',            inc:'faible',vot:15,ps:.80,sr:.40,ta:.55,cd:.60,zone:'centre',tw:'offpk', dur:'short',alts:['tp','taxi']},
  {id:'p7', e:'üöõ',n:'Livreur',           inc:'moyen', vot:24,ps:.50,sr:1.0,ta:.00,cd:1.0,zone:'centre',tw:'peak',  dur:'short',alts:[]},
  {id:'p8', e:'üèî',n:'Navette Nendaz',    inc:'moyen', vot:26,ps:.55,sr:.85,ta:.35,cd:.85,zone:'centre',tw:'peak',  dur:'long', alts:['pr_tp']},
  {id:'p9', e:'üåø',n:'T√©l√©travail flex',  inc:'√©lev√©', vot:38,ps:.30,sr:.10,ta:.70,cd:.30,zone:'centre',tw:'offpk', dur:'short',alts:['tp','velo']},
  {id:'p10',e:'üîß',n:'Technicien',        inc:'moyen', vot:22,ps:.60,sr:.70,ta:.40,cd:.75,zone:'emploi',tw:'peak',  dur:'long', alts:['covoit']},
  {id:'p11',e:'‚ôø',n:'PMR',               inc:'faible',vot:16,ps:.75,sr:.90,ta:.25,cd:.95,zone:'centre',tw:'offpk', dur:'short',alts:['taxi']},
  {id:'p12',e:'üé≠',n:'R√©sident centre',   inc:'moyen', vot:20,ps:.65,sr:.50,ta:.60,cd:.50,zone:'centre',tw:'offpk', dur:'long', alts:['velo','tp']},
];

const BL = {pk:3.0,op:1.5,pg:1.0,pr:0.0,td:0,pb:0,cv:false,td2:false,tx:false,f3:false,bd:false,dyn:false};
const PRESETS = {
  actuel:    {pk:3.0,op:1.5,pg:1.0,pr:0.0,td:0, pb:0,cv:false,td2:false,tx:false,f3:false,bd:false,dyn:false},
  modere:    {pk:4.5,op:2.0,pg:1.5,pr:0.5,td:20,pb:1,cv:true, td2:false,tx:false,f3:false,bd:false,dyn:false},
  ambitieux: {pk:7.0,op:2.5,pg:2.0,pr:1.0,td:35,pb:2,cv:true, td2:true, tx:true, f3:true, bd:true, dyn:false},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENGINE
// Softmax temp=0.6 ‚Äî Hess et al. 2017 (DCM Swiss transport)
// Elasticity -0.30 ‚Äî Shoup 2005 + EU meta-analysis 2020-23
// VOT 12-38 CHF/h ‚Äî DETEC 2018, adjusted Valais
// Marginal car cost 0.18 CHF/km ‚Äî TCS 2023
// TP base fare ~3.80 CHF ‚Äî proxy CFF/CarPostal 2024
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function softmax(c,t=.6){
  const u=c.map(v=>isFinite(v)&&v<9e4?-v/t:-999),mx=Math.max(...u);
  const e=u.map(v=>Math.exp(Math.max(v-mx,-100))),s=e.reduce((a,b)=>a+b,0);
  return e.map(v=>v/s);
}
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));

/**
 * Real parking cost ‚Äî based on actual Sion tariffs
 * Planta/Scex baseline: 3.00 CHF/h (source: sion.ch 2025)
 * Roches-Brunes: 2.00 CHF/h (source: sion.ch 2024)
 * Progressive pricing: optional scenario parameter
 * Free 1st hour: YES at Planta, Scex, Roches-Brunes
 */
function parkCost(zoneId,sc,tw,durH){
  let ph;
  if(zoneId==='centre'||zoneId==='gare') ph=tw==='peak'?sc.pk:sc.op;
  else if(zoneId==='nord') ph=(tw==='peak'?sc.pk:sc.op)*0.67; // Roches-Brunes area ~2/3 of centre
  else if(zoneId==='pr') ph=sc.pr;
  else ph=ZONES[zoneId]?.price||0;
  if(sc.f3&&durH<=.5) return 0;
  if(sc.f3&&durH<=1.0) durH=Math.max(0,durH-.5);
  if(sc.pg>1&&durH>1) return ph*1+(durH-1)*ph*sc.pg;
  return ph*durH;
}

function decomp(p,sc){
  const z=ZONES[p.zone]||ZONES.centre;
  const durH=p.dur==='short'?1.0:3.5;
  const distKm=clamp((1-z.acc)*22+2,1.5,30);
  // ‚îÄ CAR: parking + (carTime/60√óVOT) + friction + km√ó0.18 [TCS 2023]
  const park=parkCost(p.zone,sc,p.tw,durH);
  const ctMin=clamp(z.tpMin*.8,4,40);
  const cTime=(ctMin/60)*p.vot;
  const fric=z.fric*p.vot*.25;
  const run=distKm*.18;
  const dynSur=sc.dyn?(park+cTime+fric+run)*.08:0; // +8% congestion
  const carTot=park+cTime+fric+run+dynSur;
  // ‚îÄ TP: ticket√ódisc + (totalTime/60√óVOT) + access [DETEC 2018]
  const tpBase=3.80; // CHF ‚Äî proxy CFF/CarPostal 2024
  const disc=p.tw==='offpk'?1-sc.td/100:1;
  const prBon=(p.zone==='pr'||p.alts.includes('pr_tp'))?sc.pb:0;
  const tick=Math.max(0,tpBase*disc-prBon);
  const wait=p.tw==='peak'?7:14;
  const tpTime=((z.tpMin+wait)/60)*p.vot;
  const acc=(1-z.acc)*2.8;
  const budCr=sc.bd&&(p.inc==='faible'||p.inc==='moyen')?(50/22):0;
  const tpTot=Math.max(.1,tick+tpTime+acc-budCr);
  // ‚îÄ COVOIT: carTot√ó0.55 + sched inconvenience
  let covTot=9e4;
  if(sc.cv&&p.sr<.88&&p.alts.includes('covoit')){
    const m=clamp(1-p.sr*.75,.1,.9);
    if(m>.3) covTot=carTot*.55+p.sr*p.vot*.45*.5;
  }
  // ‚îÄ TAD: 2.50 + km√ó0.35 + time√ó1.25/60√óVOT (pilotes romands 2022-23)
  let tadTot=9e4;
  if(sc.td2) tadTot=2.5+distKm*.35+(z.tpMin*1.25/60)*p.vot;
  // ‚îÄ TAXI-BONS: (12+km√ó2.8)‚àí8 CHF bon (TCS 2023 tarif, hyp. 8 CHF)
  let taxTot=9e4;
  const taxEl=p.alts.includes('taxi')&&(p.inc==='faible'||p.id==='p4'||p.id==='p11');
  if(sc.tx&&taxEl) taxTot=(12+distKm*2.8)-8+(ctMin*1.1/60)*p.vot;
  return {car:{park,cTime,fric,run,dynSur,tot:carTot},tp:{tick,tpTime,acc,budCr,tot:tpTot},
    cov:{tot:covTot},tad:{tot:tadTot},tax:{tot:taxTot},distKm,durH,z};
}

function mSplit(d,p){
  return softmax([
    d.car.tot*(0.70+p.cd*.60),
    d.tp.tot*(1.20-p.ta*.50),
    d.cov.tot, d.tad.tot, d.tax.tot
  ]);
}

function getSc(){
  return {
    pk: +document.getElementById('sl-pk').value,
    op: +document.getElementById('sl-op').value,
    pg: +document.getElementById('sl-pg').value,
    pr: +document.getElementById('sl-pr').value,
    td: +document.getElementById('sl-td').value,
    pb: +document.getElementById('sl-pb').value,
    cv: document.getElementById('tog-cv').checked,
    td2:document.getElementById('tog-td').checked,
    tx: document.getElementById('tog-tx').checked,
    f3: document.getElementById('tog-f3').checked,
    bd: document.getElementById('tog-bd').checked,
    dyn:document.getElementById('tog-dyn').checked,
  };
}

function runSim(sc){
  const MNAMES=['Voiture','TP','Covoiturage','TAD','Taxi-bons'];
  const res=PERSONAS.map(p=>{
    const bd=decomp(p,BL), sd=decomp(p,sc);
    const bs=mSplit(bd,p), ss=mSplit(sd,p);
    const bi=bs.indexOf(Math.max(...bs)), si=ss.indexOf(Math.max(...ss));
    const bC=[bd.car.tot,bd.tp.tot,bd.cov.tot,bd.tad.tot,bd.tax.tot][bi];
    const sC=[sd.car.tot,sd.tp.tot,sd.cov.tot,sd.tad.tot,sd.tax.tot][si];
    const bCost=isFinite(bC)?bC:bd.car.tot;
    const sCost=isFinite(sC)&&sC<9e4?sC:sd.car.tot;
    const delta=sCost-bCost;
    const eqFlag=p.inc==='faible'&&delta>Math.abs(bCost)*.15;
    return {p,bd,sd,bs,ss,bCost,sCost,delta,bM:MNAMES[bi],sM:MNAMES[si],eqFlag};
  });
  const zr={};
  for(const zid of Object.keys(ZONES)){
    const pr=res.filter(r=>r.p.zone===zid);
    if(!pr.length) continue;
    const avgCb=pr.reduce((s,r)=>s+r.bs[0],0)/pr.length;
    const avgCs=pr.reduce((s,r)=>s+r.ss[0],0)/pr.length;
    const shi=clamp((avgCb-avgCs)/Math.max(avgCb,.01),0,1);
    const spl=[0,1,2,3,4].map(i=>pr.reduce((s,r)=>s+r.ss[i],0)/pr.length);
    const psig=Math.min((sc.pk-BL.pk)*8,28);
    const alt=(sc.cv?10:0)+(sc.td2?8:0)+(sc.tx?5:0)+(sc.bd?4:0);
    const el=clamp(Math.round(shi*55+ZONES[zid].acc*15+psig*.4+alt),0,100);
    const cat=el>=60?'v':el>=35?'o':'r';
    zr[zid]={shi,spl,el,cat,avgCb,avgCs};
  }
  const eqN=res.filter(r=>r.eqFlag).length;
  const gSh=Object.values(zr).reduce((s,z)=>s+z.shi,0)/Object.keys(zr).length;
  // Revenue: (Planta 570 + Scex 658) √ó occupancy √ó avg duration √ó price
  // Baseline = real: peak 3CHF√ó2h + offpeak 1.5CHF√ó4h √ó 0.65 occ
  const bRev=(BL.pk*2+BL.op*4)*(570+658)*.65;
  const sRev=(sc.pk*2+sc.op*4)*(570+658)*Math.max(.15,.65-gSh*.4);
  const co2=Math.round(gSh*13000*300*8*.00021);
  return {res,zr,gSh,eqN,bRev,sRev,dRev:sRev-bRev,co2};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastSim=null, selZoneId='centre', selDP='p1', curFilter='all';

function simNow(){
  const sc=getSc();
  lastSim=runSim(sc);
  updateKPIs(); updatePIP(sc); updateZoneColors(); updateMSO();
  updatePersonas(); updateOD(); updateEq();
  if(document.getElementById('view-decomp').classList.contains('on')) renderDecomp();
  if(document.getElementById('view-compare').classList.contains('on')) renderCompare();
  if(document.getElementById('view-narrative').classList.contains('on')) renderNarr();
}

// ‚îÄ KPIs ‚îÄ
function setKPI(vid,did,val,delta,cls){
  const v=document.getElementById(vid),d=document.getElementById(did);
  if(v){v.textContent=val;v.classList.add('fl');setTimeout(()=>v.classList.remove('fl'),400)}
  if(d){d.textContent=delta;d.className='kpi-d '+cls}
}
function updateKPIs(){
  const s=lastSim,sh=Math.round(s.gSh*100),rd=Math.round(s.dRev);
  setKPI('kv-sh','kd-sh',sh+'%', sh>15?`‚Üë +${sh} pts vs baseline`:'‚Üí Effet mod√©r√©', sh>15?'up':'nu');
  setKPI('kv-rv','kd-rv',Math.round(s.sRev)+' CHF', `${rd>=0?'+':''}${rd} CHF/j vs actuel`, rd>=0?'up':'dn');
  setKPI('kv-co','kd-co',s.co2+'t', s.co2>100?'‚úì Trajectoire 2030':'‚Üí Impact limit√©', s.co2>100?'up':'nu');
  setKPI('kv-eq','kd-eq',s.eqN+'', s.eqN>0?`‚ö† ${s.eqN} profils vuln√©rables`:'‚úì Pas de risque majeur', s.eqN>0?'dn':'up');
}

// ‚îÄ PIP ‚îÄ
function updatePIP(sc){
  const sc1={...sc,pk:sc.pk+1};
  const s1=runSim(sc1);
  const dm=((s1.gSh-lastSim.gSh)*100).toFixed(1);
  const dr=Math.round(s1.sRev-lastSim.sRev);
  const de=s1.eqN-lastSim.eqN;
  document.getElementById('pip-m').textContent=`‚àí${Math.abs(dm)}% voiture`;
  document.getElementById('pip-m').className='pip-v '+(parseFloat(dm)>0?'g':'o');
  document.getElementById('pip-r').textContent=`${dr>=0?'+':''}${dr} CHF`;
  document.getElementById('pip-r').className='pip-v '+(dr>=0?'g':'r');
  document.getElementById('pip-e').textContent=de>0?`+${de} profil(s)`:'Stable';
  document.getElementById('pip-e').className='pip-v '+(de>0?'r':'g');
  const notes=[];
  if(sc.pk>4) notes.push('Tarif pointe √©lev√© ‚Üí fort signal modal');
  else if(sc.pk<2.5) notes.push('Tarif pointe ‚â§ actuel ‚Üí signal insuffisant');
  if(sc.td>20) notes.push('Rabais TP efficace ‚Üí alternatives cr√©dibles');
  if(sc.cv) notes.push('Covoiturage activ√© ‚Üí absorbe demande r√©siduelle');
  document.getElementById('pip-n').textContent=notes[0]||'Facteur cl√© : tarif pointe centre-ville.';
}

// ‚îÄ Zone colors ‚îÄ
const CATCOL={v:'#4ade80',o:'#fbbf24',r:'#f87171'};
function updateZoneColors(){
  for(const [id,zr] of Object.entries(lastSim.zr)){
    const el=document.getElementById('zone-'+id);
    if(!el) continue;
    const strokes=el.querySelectorAll('rect,ellipse');
    strokes.forEach(s=>{if(s.getAttribute('stroke')){s.setAttribute('stroke',CATCOL[zr.cat]);s.setAttribute('stroke-opacity','0.8')}});
  }
}

// ‚îÄ Mode split overlay ‚îÄ
const MLBL=['Voiture','TP','Covoiturage','TAD','Taxi-bons'];
const MCOL=['#dc2626','#2563eb','#d97706','#8b5cf6','#0d9488'];
function updateMSO(){
  const zr=lastSim.zr[selZoneId];
  if(!zr) return;
  document.getElementById('mso-z').textContent=ZONES[selZoneId]?.lbl||selZoneId;
  document.getElementById('mso-bars').innerHTML=MLBL.map((m,i)=>{
    const pct=Math.round(zr.spl[i]*100);
    return `<div class="mso-row"><div class="mso-l">${m}</div><div class="mso-tr"><div class="mso-f" style="width:${pct}%;background:${MCOL[i]}"></div></div><div class="mso-p">${pct}%</div></div>`;
  }).join('');
}

// ‚îÄ Persona strip ‚îÄ
function updatePersonas(){
  document.getElementById('pstrip').innerHTML=lastSim.res.map(r=>{
    const d=r.delta,s=d>0.5?'+':'',dc=Math.abs(d)<.5?'neu':d>0?'pos':'neg';
    return `<div class="pchip ${r.eqFlag?'risk':''}" onclick="openPersonaMod('${r.p.id}')">
      <span class="pe">${r.p.e}</span><div class="pn">${r.p.n}</div>
      <div class="pd ${dc}">${s}${d.toFixed(1)} CHF</div></div>`;
  }).join('');
}

// ‚îÄ Equity panel ‚îÄ
function updateEq(){
  const ep=document.getElementById('eq-p'),eb=document.getElementById('eq-b');
  const risks=lastSim.res.filter(r=>r.eqFlag);
  if(risks.length){
    eb.innerHTML=`Profils expos√©s : <strong>${risks.map(r=>`${r.p.e} ${r.p.n}`).join(', ')}</strong>.<br>Hausse &gt;15% sans alternative. Activer taxi-bons ou TAD.`;
    ep.classList.add('vis');
  } else ep.classList.remove('vis');
}

// ‚îÄ OD flows ‚îÄ
function updateOD(){
  const g=document.getElementById('odg');
  g.innerHTML='';
  for(const fl of FLOWS){
    if(curFilter!=='all'&&fl.type!==curFilter) continue;
    const f=ZXY[fl.from],t=ZXY[fl.to];
    if(!f||!t) continue;
    const zr=lastSim.zr[fl.to]||{};
    const shi=zr.shi||0;
    const thick=clamp(fl.vol/700,1.5,6.5);
    const col=FC[fl.type]||'#3b82f6';
    const mk=fl.type==='pend'?'ab':fl.type==='emploi'?'ap':'at';
    const cx=(f.x+t.x)/2+(t.y-f.y)*.18,cy=(f.y+t.y)/2-(t.x-f.x)*.18;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${f.x},${f.y} Q${cx},${cy} ${t.x},${t.y}`);
    path.setAttribute('fill','none');path.setAttribute('stroke',col);
    path.setAttribute('stroke-width',thick);path.setAttribute('opacity',(.3+shi*.35).toString());
    path.setAttribute('stroke-dasharray',`${Math.round(6-shi*3)} 3`);
    path.setAttribute('marker-end',`url(#${mk})`);
    path.classList.add('odf');
    const tx=document.createElementNS('http://www.w3.org/2000/svg','text');
    tx.setAttribute('x',cx.toString());tx.setAttribute('y',(cy-7).toString());
    tx.setAttribute('text-anchor','middle');tx.setAttribute('font-size','8');
    tx.setAttribute('fill',col);tx.setAttribute('font-family','Syne');tx.setAttribute('opacity','.5');
    tx.textContent=fl.lbl+' v√©h/j ‚ö†sim';
    g.appendChild(path);g.appendChild(tx);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DECOMP VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDecomp(){
  if(!lastSim) return;
  const r=lastSim.res.find(r=>r.p.id===selDP);
  if(!r) return;
  document.getElementById('dptabs').innerHTML=PERSONAS.map(p=>{
    const ri=lastSim.res.find(x=>x.p.id===p.id);
    return `<button class="dpt ${ri?.eqFlag?'risk':''} ${p.id===selDP?'on':''}" onclick="selDPersona('${p.id}')">${p.e} ${p.n}</button>`;
  }).join('');
  const d=r.sd;
  const MODES=[
    {k:'car',lbl:'Voiture',col:'#dc2626',items:[
      {k:'Parking',    v:d.car.park,   f:'prix √ó dur√©e (+ progressif)', src:'sion.ch r√©el'},
      {k:'Co√ªt temps', v:d.car.cTime,  f:'(min/60) √ó VOT', src:'DETEC 2018'},
      {k:'Friction',   v:d.car.fric,   f:'fric √ó VOT √ó 0.25', src:'HYP'},
      {k:'Co√ªt km',    v:d.car.run,    f:'km √ó 0.18 CHF', src:'TCS 2023'},
      d.car.dynSur>0?{k:'Congestion',  v:d.car.dynSur, f:'+8% (TomTom)', src:'TomTom HYP'}:null,
    ].filter(Boolean)},
    {k:'tp', lbl:'TP',col:'#2563eb',items:[
      {k:'Billet',     v:d.tp.tick,    f:'3.80 √ó (1‚àírabais) ‚àí bonus P+R', src:'CFF proxy 2024'},
      {k:'Co√ªt temps', v:d.tp.tpTime,  f:'(min_total/60) √ó VOT', src:'DETEC 2018'},
      {k:'Acc√®s/confort',v:d.tp.acc,   f:'(1‚àíacc) √ó 2.8 CHF', src:'HYP'},
      d.tp.budCr>0?{k:'Budget mob.',  v:-d.tp.budCr,  f:'‚àí50 CHF/mois√∑22j', src:'HYP'}:null,
    ].filter(Boolean)},
    {k:'cov',lbl:'Covoiturage',col:'#d97706',items:[]},
    {k:'tad',lbl:'TAD',col:'#8b5cf6',items:[]},
  ];
  const tots={car:d.car.tot,tp:d.tp.tot,cov:d.cov.tot,tad:d.tad.tot};
  const minT=Math.min(...Object.values(tots).filter(v=>v<9e4));
  document.getElementById('cgrid').innerHTML=MODES.map(m=>{
    const tot=tots[m.k];
    if(tot>9e4) return '';
    const bTot={car:r.bd.car.tot,tp:r.bd.tp.tot,cov:r.bd.cov.tot,tad:r.bd.tad.tot}[m.k];
    const delta=tot-(bTot<9e4?bTot:tot);
    const isWin=tot===minT;
    const fml={car:'Total = parking + (carTime/60 √ó VOT) + fric + km√ó0.18',tp:'Total = billet√ó(1‚àírabais) + (totalMin/60 √ó VOT) + acc√®s',cov:'Total = carTot√ó0.55 + rigidit√©√óVOT√ó0.45√ó0.5',tad:'Total = 2.50 + km√ó0.35 + (tpMin√ó1.25/60 √ó VOT)'}[m.k];
    const rows=m.items.map(it=>{
      const pct=Math.round(Math.abs(it.v)/Math.abs(tot)*100);
      const isMinus=it.v<0;
      return `<div class="cc-r">
        <div class="cc-k"><span>${it.k}</span><span class="cc-f">${it.f} ¬∑ ${it.src}</span></div>
        <div class="cc-rv" style="color:${isMinus?'var(--tl)':'inherit'}">${it.v>=0?'':''} ${Math.abs(it.v).toFixed(2)} CHF</div>
      </div><div class="cc-bar"><div class="cc-bar-f" style="width:${pct}%;background:${m.col};opacity:.35"></div></div>`;
    }).join('');
    return `<div class="ccard ${isWin?'win':''}">
      <div class="cc-h">
        <div class="cc-m" style="color:${m.col}">${isWin?'‚úì ':''} ${m.lbl}${isWin?' <span style="font-size:9px;color:var(--tl)">optimal</span>':''}</div>
        <div class="cc-tot" style="color:${m.col}">${tot.toFixed(2)} CHF <span style="font-size:10px;color:${delta>0?'#f87171':'var(--tl)'}">${delta!==0?(delta>0?'+':'')+delta.toFixed(2):''}</span></div>
      </div>
      ${rows}
      <div class="cc-fml">${fml}</div>
    </div>`;
  }).join('');
}
function selDPersona(id){selDP=id;renderDecomp()}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPARE VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCompare(){
  if(!lastSim) return;
  const bsim=runSim(BL);
  const catCls={v:'v',o:'o',r:'r'};
  function card(zid,zr,isSc){
    const cp=isSc?zr.avgCs:zr.avgCb;
    return `<div class="zc">
      <div class="zc-h"><span class="zc-n">${ZONES[zid]?.lbl||zid}</span>
        <span class="zcb ${catCls[zr.cat]}">${zr.cat==='v'?'FORT':zr.cat==='o'?'MOD√âR√â':'FAIBLE'}</span>
      </div>
      <div class="zmets">
        <div class="zm"><div class="zmv" style="color:${CATCOL[zr.cat]}">${zr.el}</div><div class="zml">√âlasticit√©</div></div>
        <div class="zm"><div class="zmv">${Math.round(cp*100)}%</div><div class="zml">Part voiture</div></div>
        <div class="zm"><div class="zmv">${isSc?Math.round(zr.shi*100)+'%':'‚Äî'}</div><div class="zml">Shift modal</div></div>
      </div></div>`;
  }
  const zids=Object.keys(lastSim.zr);
  document.getElementById('cpb').innerHTML=zids.map(id=>card(id,bsim.zr[id]||lastSim.zr[id],false)).join('');
  document.getElementById('cps').innerHTML=zids.map(id=>card(id,lastSim.zr[id],true)).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NARRATIVE VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNarr(){
  if(!lastSim) return;
  const s=lastSim,sc=getSc();
  const sh=Math.round(s.gSh*100);
  const top=Object.entries(s.zr).sort((a,b)=>b[1].shi-a[1].shi)[0];
  const shifts=s.res.filter(r=>r.bM!==r.sM);
  const eqN=s.res.filter(r=>r.eqFlag).map(r=>`${r.p.e} ${r.p.n}`);
  const now=new Date().toLocaleString('fr-CH',{dateStyle:'short',timeStyle:'short'});
  const lv=sh>25?'fort':sh>10?'mod√©r√©':'limit√©';
  const lc=sh>25?'gn':sh>10?'or':'rd';
  const lt=sh>25?'Ce sc√©nario g√©n√®re un effet substantiel, comparable aux meilleures pratiques europ√©ennes de mod√©ration de trafic.'
    :sh>10?'Effet mod√©r√©, coh√©rent avec une politique tarifaire de premi√®re phase. Renforcement progressif envisageable.'
    :'Signal-prix insuffisant pour induire un changement significatif. Relever le tarif pointe ou renforcer les alternatives.';
  const recs=[];
  if(sc.pk<3) recs.push({t:'Maintenir ou relever le tarif pointe',b:'Le tarif actuel r√©el est de 3.00 CHF/h (Planta/Scex). En dessous, le signal est insuffisant pour les revenus moyens et √©lev√©s. Seuil recommand√© : 3.50‚Äì5.00 CHF/h.',p:'hi'});
  if(sc.td<20) recs.push({t:'Renforcer le rabais TP hors-pointe',b:'Un rabais ‚â•20‚Äì25% est n√©cessaire pour rendre les alternatives cr√©dibles. Proxy billet actuel : ~3.80 CHF (CFF/CarPostal 2024, √† v√©rifier).',p:'mi'});
  if(!sc.cv) recs.push({t:'Activer le covoiturage dynamique',b:'Co√ªt public marginal faible. Efficace pour pendulaires flexibles (Technicien, T√©l√©travail, Navette Nendaz). Matching via app existante recommand√©.',p:'mi'});
  if(!sc.td2&&Object.values(s.zr).some(z=>z.avgCs>.7)) recs.push({t:'D√©ployer TAD en zones p√©riph√©riques',b:'Nendaz (acc=0.28) et Veysonnaz (acc=0.22) sont structurellement d√©pendantes de la voiture sans TAD. Co√ªt estim√©: 2.50+0.35/km.',p:'mi'});
  if(s.eqN>0&&!sc.tx) recs.push({t:'Activer les taxi-bons',b:`${eqN.join(', ')} subissent une hausse sans alternative. Taxi-bons (8 CHF/bon, hypoth√®se) = mesure la plus cibl√©e et rapide √† d√©ployer.`,p:'hi'});
  recs.push({t:'Pilote 90 jours ‚Äî Centre + tarif progressif',b:'Tester le tarif progressif (√ó1.5 apr√®s 1h) sur le seul p√©rim√®tre Centre-ville avant g√©n√©ralisation. KPIs: taux d\'occupation, recettes, retours commer√ßants.',p:'lo'});

  document.getElementById('nvw').innerHTML=`
    <h2 class="nv-title">Synth√®se politique</h2>
    <div class="nv-meta">
      <span style="width:6px;height:6px;border-radius:50%;background:var(--gn);display:inline-block;animation:pulse 2s ease-in-out infinite"></span> Calcul√© le ${now}
      <span style="color:var(--tx3)">¬∑</span><span class="stag s">OD estim√©</span><span class="stag h">Mod√®le hyp.</span><span class="stag r">Tarifs r√©els</span>
    </div>
    <div class="nhl ${lc}">
      <div class="nhl-t">Impact global ‚Äî niveau ${lv}</div>
      <div class="nhl-b">
        Report modal : <strong>${sh}%</strong> r√©duction de la part voiture.
        Recettes : <strong>${Math.round(s.sRev)} CHF/j</strong> (${Math.round(s.dRev)>=0?'+':''}${Math.round(s.dRev)} CHF vs actuel).
        CO‚ÇÇ √©vit√© : <strong>${s.co2}t/an</strong>.
        <br style="margin-top:5px">${lt}
      </div>
    </div>
    ${top?`<div class="nb"><div class="nb-t">Zone √† plus fort potentiel</div>
      <div style="padding:9px 12px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rs);display:flex;align-items:center;gap:9px;max-width:480px">
        <div style="width:8px;height:8px;border-radius:50%;background:${CATCOL[top[1].cat]};flex-shrink:0"></div>
        <div><div style="font-weight:600;font-size:13px;color:var(--tx)">${ZONES[top[0]]?.lbl||top[0]}</div>
        <div style="font-size:10px;color:var(--tx3);margin-top:1px;font-family:'JetBrains Mono',monospace">Shift: ${Math.round(top[1].shi*100)}% ¬∑ √âlasticit√©: ${top[1].el}/100</div></div>
      </div></div>`:''}
    ${shifts.length?`<div class="nb"><div class="nb-t">Basculements modaux probables</div>
      ${shifts.slice(0,5).map(r=>`<div class="nmsr">
        <span class="nmsr-e">${r.p.e}</span>
        <span class="nmsr-l">${r.p.n}</span>
        <span class="nmsr-fr">${r.bM}</span>
        <span style="color:var(--tx3);font-size:10px">‚Üí</span>
        <span class="nmsr-to">${r.sM}</span>
        <span class="nmsr-d" style="color:${r.delta>0?'#f87171':'var(--tl)'}">${r.delta>0?'+':''}${r.delta.toFixed(1)} CHF</span>
      </div>`).join('')}
    </div>`:''}
    ${s.eqN>0
      ?`<div class="nhl rd"><div class="nhl-t">‚ö† Risques √©quit√© ‚Äî intervention requise</div>
        <div class="nhl-b">Profils expos√©s : <strong>${eqN.join(', ')}</strong>. Hausse &gt;15% sans alternative accessible. Sans mesure compensatoire, ce sc√©nario cr√©e une in√©galit√© d'acc√®s √† la mobilit√©.</div></div>`
      :`<div class="nhl gn"><div class="nhl-t">‚úì √âquit√© ‚Äî aucun risque majeur</div>
        <div class="nhl-b">Aucun profil √† revenu faible n'est p√©nalis√© disproportionnellement dans ce sc√©nario.</div></div>`}
    <div class="nb"><div class="nb-t">Recommandations ‚Äî par ordre de priorit√©</div>
      ${recs.map(r=>`<div class="nrec"><div class="nrec-h"><div class="nrec-t">${r.t}</div>
        <span class="pb ${r.p}">${r.p==='hi'?'Urgent':r.p==='mi'?'Important':'Pilote'}</span></div>
        <div class="nrec-b">${r.b}</div></div>`).join('')}
    </div>
    <div class="ndisc">
      ‚ö† LIMITES ‚Äî r√©sultats indicatifs uniquement.<br>
      Tarifs parkings : R√âELS (sion.ch 2024‚Äì2025 ¬∑ Planta 3 CHF/h, Scex 3 CHF/h, Roches-Brunes 2 CHF/h).<br>
      Capacit√©s : R√âELLES (Planta 570, Scex 658, RB 370 ‚Äî Le Nouvelliste 2019 + sion.ch).<br>
      Flux OD : ESTIM√âS (distance √ó population) ‚Äî calibration TomTom Move recommand√©e.<br>
      √âlasticit√©s, VOT, comportement : MOD√àLE HYPOTH√âTIQUE non calibr√© sur donn√©es s√©dunoise.<br>
      Ce simulateur ne remplace pas une √©tude de trafic officielle.<br>
      Softmax t=0.6 (Hess 2017) ¬∑ √©lasticit√© ‚àí0.30 (Shoup 2005) ¬∑ VOT DETEC 2018 ¬∑ TCS 2023.
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOOLTIP + ZONE INTERACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded',()=>{
  const tt=document.getElementById('mtt');
  const mapw=document.getElementById('mapw');
  document.querySelectorAll('.zone-g,.pmark').forEach(el=>{
    el.addEventListener('mousemove',e=>{
      const zid=el.dataset.zone;
      if(!zid) return;
      const z=ZONES[zid],zr=lastSim?.zr[zid];
      document.getElementById('mtt-n').textContent=z?.lbl||zid;
      document.getElementById('mtt-pr').textContent=z?.price>0?z.price.toFixed(2)+' CHF/h':'Gratuit';
      document.getElementById('mtt-car').textContent=zr?Math.round(zr.avgCs*100)+'%':'‚Äî';
      document.getElementById('mtt-sh').textContent=zr?'+'+Math.round(zr.shi*100)+'%':'‚Äî';
      document.getElementById('mtt-el').textContent=zr?zr.el+'/100':'‚Äî';
      document.getElementById('mtt-src').textContent='Source: '+(z?.src||'‚Äî');
      const wr=mapw.getBoundingClientRect();
      tt.style.left=(e.clientX-wr.left)+'px';
      tt.style.top=(e.clientY-wr.top)+'px';
      tt.classList.add('vis');
    });
    el.addEventListener('mouseleave',()=>tt.classList.remove('vis'));
  });
  document.querySelectorAll('input[type=range]').forEach(upTrack);
  simNow();
});

function selZone(id){
  selZoneId=id;
  if(lastSim) updateMSO();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSONA MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openPersonaMod(id){
  if(!lastSim) return;
  const r=lastSim.res.find(r=>r.p.id===id);
  if(!r) return;
  const p=r.p;
  document.getElementById('mp-e').textContent=p.e;
  document.getElementById('mp-n').textContent=p.n;
  document.getElementById('mp-d').textContent=`${p.inc} ¬∑ ${ZONES[p.zone]?.lbl||p.zone} ¬∑ ${p.tw==='peak'?'heure de pointe':'hors-pointe'} ¬∑ ${p.dur==='short'?'courte dur√©e':'longue dur√©e'}`;
  document.getElementById('mp-rows').innerHTML=[
    {k:'Co√ªt baseline',  v:`${r.bCost.toFixed(2)} CHF ¬∑ mode: ${r.bM}`},
    {k:'Co√ªt sc√©nario',  v:`${r.sCost.toFixed(2)} CHF ¬∑ mode: ${r.sM}`},
    {k:'Delta',          v:`${r.delta>=0?'+':''}${r.delta.toFixed(2)} CHF`},
    {k:'VOT',            v:`${p.vot} CHF/h (DETEC 2018)`},
    {k:'Sensibilit√© prix',v:`${Math.round(p.ps*100)}%`},
    {k:'Rigidit√© horaire',v:`${Math.round(p.sr*100)}%`},
    {k:'Affinit√© TP',    v:`${Math.round(p.ta*100)}%`},
    {k:'D√©pendance auto',v:`${Math.round(p.cd*100)}%`},
    {k:'Alternatives',   v:p.alts.join(', ')||'Aucune'},
  ].map(row=>`<div class="mc-row"><span class="mc-k">${row.k}</span><span class="mc-v">${row.v}</span></div>`).join('');
  document.getElementById('mp-f').innerHTML=r.eqFlag
    ?'‚ö† Risque √©quit√©: hausse &gt;15% sans alternative. Source: HYP (revenu faible + delta &gt; 15%)'
    :'‚úì Pas de risque √©quit√© dans ce sc√©nario.';
  document.getElementById('mod-p').classList.add('open');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOMTOM + MISC UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTTModal(){document.getElementById('mod-tt').classList.add('open')}
function closeMod(id,e){if(e.target.id===id)document.getElementById(id).classList.remove('open')}

async function testTomTom(){
  const btn=event.target;
  btn.textContent='Test en cours‚Ä¶';btn.disabled=true;
  try{
    const r=await fetch('/api/traffic/flow');
    if(r.ok){
      const d=await r.json();
      document.getElementById('ttdot').className='tt-dot ok';
      document.getElementById('ttlbl').textContent='TomTom ¬∑ Live';
      const badge=document.getElementById('ttlbl').closest('.tt-btn');
      btn.textContent='‚úì Connexion OK';
      setTimeout(()=>{btn.textContent='Tester /api/traffic/flow';btn.disabled=false},2000);
    } else throw new Error('HTTP '+r.status);
  } catch(e){
    btn.textContent='‚úó Erreur ‚Äî voir console';btn.disabled=false;
    setTimeout(()=>{btn.textContent='Tester /api/traffic/flow'},2000);
  }
}

function selPark(id){
  document.querySelectorAll('.pcard').forEach(c=>c.classList.remove('sel'));
  const el=document.getElementById('pcard-'+id);
  if(el) el.classList.add('sel');
}

function setMode(m,btn){
  document.querySelectorAll('.mbtn').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('app').classList.toggle('mode-simple',m==='simple');
  document.getElementById('app').classList.toggle('mode-expert',m==='expert');
}

function swV(id,btn){
  document.querySelectorAll('.vt').forEach(t=>t.classList.remove('on'));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('view-'+id).classList.add('on');
  if(!lastSim) return;
  if(id==='decomp') renderDecomp();
  if(id==='compare') renderCompare();
  if(id==='narrative') renderNarr();
}

function loadSc(name,btn){
  document.querySelectorAll('.stab').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  if(name==='custom') return;
  const p=PRESETS[name];if(!p) return;
  const set=(id,v)=>{const el=document.getElementById(id);if(el){el.value=v;upTrack(el)}};
  set('sl-pk',p.pk);slU(document.getElementById('sl-pk'),'v-pk','CHF/h');
  set('sl-op',p.op);slU(document.getElementById('sl-op'),'v-op','CHF/h');
  set('sl-pg',p.pg);slM(document.getElementById('sl-pg'),'v-pg');
  set('sl-pr',p.pr);slU(document.getElementById('sl-pr'),'v-pr','CHF/h');
  set('sl-td',p.td);slU(document.getElementById('sl-td'),'v-td','%');
  set('sl-pb',p.pb);slU(document.getElementById('sl-pb'),'v-pb','CHF');
  const tog=(id,v)=>{const el=document.getElementById(id);if(el) el.checked=v};
  tog('tog-cv',p.cv);tog('tog-td',p.td2);tog('tog-tx',p.tx);
  tog('tog-f3',p.f3);tog('tog-bd',p.bd);tog('tog-dyn',p.dyn);
  simNow();
}

function setF(f,btn){
  curFilter=f;
  document.querySelectorAll('.fc[data-f]').forEach(c=>c.classList.remove('on'));
  btn.classList.add('on');
  if(lastSim) updateOD();
}

function upTrack(el){
  const mn=parseFloat(el.min),mx=parseFloat(el.max),v=parseFloat(el.value);
  el.style.setProperty('--pct',((v-mn)/(mx-mn)*100)+'%');
}
function slU(el,vid,unit){
  document.getElementById(vid).textContent=parseFloat(el.value).toFixed(2)+' '+unit;
  upTrack(el);
}
function slM(el,vid){
  document.getElementById(vid).textContent='√ó'+parseFloat(el.value).toFixed(2);
  upTrack(el);
}
</script>
</body>
</html>
